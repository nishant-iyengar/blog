(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,7821,e=>{"use strict";let t,a;var i=e.i(30648),s=e.i(18939),r=e.i(15055);function n(e,t,a){if(!t(e))throw Error(a);return e}function o(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function l(e){return"number"==typeof e&&!isNaN(e)}function d(e,t){return!!Array.isArray(e)&&(!t||e.every(t))}function c(e){return Array.isArray(e)&&e.length>0&&e.every(e=>Array.isArray(e)&&e.every(e=>"number"==typeof e&&!isNaN(e)))}function h(e){return e instanceof Error}function u(e,t,a){return!!o(e)&&t in e&&a(e[t])}function g(e,t,a){let i;if("string"==typeof e)try{i=JSON.parse(e)}catch{throw Error(`Invalid JSON: ${a}`)}else try{let t=JSON.stringify(e);i=JSON.parse(t)}catch{throw Error(`Failed to serialize: ${a}`)}return n(i,t,a)}let m=new Set(["arrowup","arrowdown","arrowleft","arrowright"," ","w","a","s","d","q","p"]);function p(e){let t=(0,s.useRef)(new Set),[a,i]=(0,s.useState)(!1),r=(0,s.useRef)(e?.gameOver??!1);return(0,s.useEffect)(()=>{r.current=e?.gameOver??!1},[e?.gameOver]),(0,s.useEffect)(()=>{let e=e=>{let a;if(!r.current){if(" "===e.key||"Space"===e.code)a=" ";else if(e.key.startsWith("Arrow")||e.code.startsWith("Arrow")){let t=e.key.replace("Arrow","").toLowerCase()||e.code.replace("Arrow","").toLowerCase();a=`arrow${t}`}else a=e.code.startsWith("Key")?e.code.replace("Key","").toLowerCase():e.key.toLowerCase();if(m.has(a)){if(e.preventDefault(),e.stopPropagation(),"p"===a)return void i(e=>!e);t.current.add(a)}}},a=e=>{let a;if(!r.current){if(" "===e.key||"Space"===e.code)a=" ";else if(e.key.startsWith("Arrow")||e.code.startsWith("Arrow")){let t=e.key.replace("Arrow","").toLowerCase()||e.code.replace("Arrow","").toLowerCase();a=`arrow${t}`}else a=e.code.startsWith("Key")?e.code.replace("Key","").toLowerCase():e.key.toLowerCase();m.has(a)&&(e.preventDefault(),e.stopPropagation(),"p"!==a&&t.current.delete(a))}};return window.addEventListener("keydown",e,!0),window.addEventListener("keyup",a,!0),()=>{window.removeEventListener("keydown",e,!0),window.removeEventListener("keyup",a,!0)}},[]),{keysRef:t,isPaused:a}}function f(){let[e,t]=(0,s.useState)({blue:null,red:null});return(0,s.useEffect)(()=>{let e=new Image;e.src="/games/tank-blue.svg",e.onload=()=>{t(t=>({...t,blue:e}))};let a=new Image;a.src="/games/tank-red.svg",a.onload=()=>{t(e=>({...e,red:a}))}},[]),e}let x=24,y=10,v=1.4,w=5,b=3,T=2,k=1.8,S=5,N=7e3,M=500,j=3,E=72,A=150,P=.25,D=120,R=60,I=2,L=2,C=3,B=3,F=-3,z=7,$=4,q=10,W=!0,O=x,G=y,U=O/2,H=v,V=H*k,Q=w,Y=1e3/E,J=S,_=N,X=P,K=D,Z=R;function ee(e,t,a,i,s,r,n,o){return e<s+n&&e+a>s&&t<r+o&&t+i>r}function et(e,t,a,i){let s=e.x,r=e.y,n=t.x,o=t.y,l=!1,d=s-0<i.left,c=s+0>i.right,h=r-0<i.top,u=r+0>i.bottom;return(d||c)&&(h||u)?(d?(s=i.left+0,n=-n):c&&(s=i.right-0,n=-n),h?(r=i.top+0,o=-o):u&&(r=i.bottom-0,o=-o),l=!0):(d?(s=i.left+0,n=-n,l=!0):c&&(s=i.right-0,n=-n,l=!0),h?(r=i.top+0,o=-o,l=!0):u&&(r=i.bottom-0,o=-o,l=!0)),{newPosition:{x:s,y:r},newVelocity:{x:n,y:o},bounced:l}}function ea(e,t,a,i,s){let r=a/2,n=e.x-r,o=e.x+r,l=e.y-r,d=e.y+r,c=t.x,h=t.y,u=!1;if(n<i.x+i.width&&o>i.x&&l<i.y+i.height&&d>i.y){let t=s?.x??e.x,a=s?.y??e.y,n=Math.abs(t-i.x),o=Math.abs(t-(i.x+i.width)),l=Math.abs(a-i.y),d=Math.abs(a-(i.y+i.height)),g=Math.min(n,o,l,d),m=e.x,p=e.y;return g===n?(c=-c,m=i.x-r,u=!0):g===o?(c=-c,m=i.x+i.width+r,u=!0):g===l?(h=-h,p=i.y-r,u=!0):g===d&&(h=-h,p=i.y+i.height+r,u=!0),{newPosition:{x:m,y:p},newVelocity:{x:c,y:h},bounced:u}}return{newPosition:{x:e.x,y:e.y},newVelocity:{x:c,y:h},bounced:!1}}function ei(e,t,a){let i=0,s=0,r=a.influenceRadius*a.influenceRadius;for(let n of t){let t=n.x-e.x,o=n.y-e.y,l=t*t+o*o;if(l>=r||0===l)continue;let d=function(e,t,a){let i=t.x-e.x,s=t.y-e.y,r=i*i+s*s;if(r>=a.influenceRadius*a.influenceRadius||0===r)return{x:0,y:0};let n=Math.sqrt(r),o=Math.max(n,a.minDistance),l=a.gravitationalConstant*a.sourceMass/(o*o);return void 0!==a.maxAcceleration&&(l=Math.min(l,a.maxAcceleration)),{x:i/n*l,y:s/n*l}}(e,n,a);i+=d.x,s+=d.y}return{x:i,y:s}}function es(e,t){let a=Math.sqrt(e.x*e.x+e.y*e.y);if(a<t&&a>0){let i=t/a;return{x:e.x*i,y:e.y*i}}return e}let er=Math.PI/180,en=180/Math.PI;function eo(e,t,a,i,s,r,n,o){let l=(O-G)/2,d=e+l,c=t+l;if(d<-.001||c<-.001||d+G>a+.001||c+G>i+.001)return!1;for(let e of s)if(ee(d,c,G,G,e.x,e.y,e.width,e.height))return!1;for(let e of n){let t=e.x-e.size,a=e.x+e.size,i=e.y-e.size;if(ee(d,c,G,G,t,i,a-t,e.y+e.size-i))return!1}return!0}function el(e,t,a,i){let s=a-e,r=i-t;return Math.sqrt(s*s+r*r)}function ed(e,t){return el(e.x,e.y,t.x,t.y)}function ec(e){for(;e>180;)e-=360;for(;e<-180;)e+=360;return e}function eh(e,t){let a=t.x-e.x;return Math.atan2(t.y-e.y,a)*en}function eu(e,t,a,i){let s=t*er;return{x:e.x+O/2+Math.cos(s)*(O/2+T),y:e.y+O/2+Math.sin(s)*(O/2+T),angle:t,speed:V,owner:i,createdAt:a,vx:Math.cos(s)*V,vy:Math.sin(s)*V}}function eg(e){return{x:e.x+U,y:e.y+U}}function em(e,t,a,i){let s=(O-G)/2;return{x:Math.max(-s,Math.min(e,a-O+s)),y:Math.max(-s,Math.min(t,i-O+s))}}function ep(e){let t=new Map;for(let a of e)a.exploding||t.set(a.owner,(t.get(a.owner)||0)+1);return t}function ef(e){return function(e,t,a){let{tank:i,keys:s,tickTime:r,lastShotTime:n,bullets:o,mapWidth:l,mapHeight:d,barriers:c,suns:h,allTanks:u,tankIndex:g}=e,m=i.angle,p=i.x,f=i.y,x=[],y=n;if(s.has(t.rotateLeft)&&(m-=Q),s.has(t.rotateRight)&&(m+=Q),s.has(t.moveForward)){let e=m*er,t=p+Math.cos(e)*H,a=f+Math.sin(e)*H;eo(t,a,l,d,c,u,h,g)&&(p=t,f=a)}if(s.has(t.moveBackward)){let e=m*er,t=p+-Math.cos(e)*H,a=f+-Math.sin(e)*H;eo(t,a,l,d,c,u,h,g)&&(p=t,f=a)}if(s.has(t.shoot)&&r-n>A&&(ep(o).get(a)||0)<J){let e=eu({...i,x:p,y:f,angle:m},m,r,a);x.push(e),y=r}let v=em(p,f,l,d);return{updatedTank:{...i,x:v.x,y:v.y,angle:m},newBullets:x,lastShotTime:y}}(e,{rotateLeft:"arrowleft",rotateRight:"arrowright",moveForward:"arrowup",moveBackward:"arrowdown",shoot:" "},"blue")}let ex=null,ey=null,ev=null,ew=null,eb=null;function eT(e,t,a,i,s){if(!e||"number"!=typeof e.width||"number"!=typeof e.height)return{x:90,y:90,angle:0};let r=e.width,n=e.height,o=r-O-16,l=n-O-16;if(isNaN(o)||isNaN(l)||o<=0||l<=0)return e.spawnPoints&&e.spawnPoints.length>0?{x:e.spawnPoints[0].x,y:e.spawnPoints[0].y,angle:e.spawnPoints[0].angle}:{x:8,y:8,angle:0};for(let r=0;r<100;r++){let r=8+Math.random()*o,n=8+Math.random()*l;if(!(s&&50>ed({x:r,y:n},s))&&eo(r,n,e.width,e.height,t,a,i))return{x:r,y:n,angle:360*Math.random()}}let d=e.spawnPoints;if(!d||0===d.length)return{x:8,y:8,angle:0};for(let r of d)if(eo(r.x,r.y,e.width,e.height,t,a,i)){if(s&&50>ed(r,s))continue;return{x:r.x,y:r.y,angle:r.angle}}return{x:d[0].x,y:d[0].y,angle:d[0].angle}}function ek(e,t,a){let i=eT(e,t||[],[],a||[]);("number"!=typeof i.x||"number"!=typeof i.y||isNaN(i.x)||isNaN(i.y))&&(i.x=90,i.y=90,i.angle=0);let s=eT(e,t,[{x:i.x,y:i.y,angle:i.angle,lives:b,color:"blue"}],a,i);return("number"!=typeof s.x||"number"!=typeof s.y||isNaN(s.x)||isNaN(s.y))&&(s.x=e.spawnPoints&&e.spawnPoints.length>1?e.spawnPoints[1].x:390,s.y=e.spawnPoints&&e.spawnPoints.length>1?e.spawnPoints[1].y:270,s.angle=e.spawnPoints&&e.spawnPoints.length>1?e.spawnPoints[1].angle:180),[{x:i.x,y:i.y,angle:i.angle,lives:b,color:"blue",exploding:void 0,explosionStartTime:void 0,respawning:void 0,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0},{x:s.x,y:s.y,angle:s.angle,lives:b,color:"red",exploding:void 0,explosionStartTime:void 0,respawning:void 0,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0}]}function eS(e,t,a,i,s,r,n=Y){let o=[],l=e.x,d=e.y,c=e.vx,h=e.vy,u=0,g=j,m=!1,p=W?[]:t.map(e=>({x:e.x,y:e.y})),f={gravitationalConstant:X,sourceMass:K,influenceRadius:Z,minDistance:I,maxAcceleration:.3*V};for(o.push({x:l,y:d,time:u});u<r&&!m;){let e=W?{x:0,y:0}:ei({x:l,y:d},p,f),t=c+e.x,r=h+e.y,x=es({x:t,y:r},.5);t=x.x,r=x.y;let y=l+t,v=d+r,w=et({x:y,y:v},{x:t,y:r},g,{left:0,right:i,top:0,bottom:s});for(let e of(w.bounced&&(y=w.newPosition.x,v=w.newPosition.y,t=w.newVelocity.x,r=w.newVelocity.y),a)){let a=ea({x:y,y:v},{x:t,y:r},g,{x:e.x,y:e.y,width:e.width,height:e.height},{x:l,y:d});a.bounced&&(y=a.newPosition.x,v=a.newPosition.y,t=a.newVelocity.x,r=a.newVelocity.y)}if(l=y,d=v,c=t,h=r,u+=n,(0===o.length||u-o[o.length-1].time>=5*n)&&o.push({x:l,y:d,time:u}),.5>Math.sqrt(t*t+r*r)){m=!0;break}}return{points:o,isBlocked:m,endTime:u}}var eN=e.i(68747);let eM=eN.default.rl.action.numDiscreteActions,ej=eN.default.rl.action.actions;ej.map(e=>[e.id,e]),ej.map(e=>[e.name,e]),ej.length!==eM&&console.warn(`Warning: Action definitions count (${ej.length}) doesn't match NUM_DISCRETE_ACTIONS (${eM}) in config`);for(let e=0;e<ej.length;e++)ej[e].id!==e&&console.warn(`Warning: Action at index ${e} has ID ${ej[e].id}, expected ${e}`);let eE=null,eA=null;function eP(e){let{aiTank:t,enemyTank:a,bullets:i,suns:s,barriers:r,mapWidth:n,mapHeight:o}=e,l=[];l.push(eD(t.x,0,n)),l.push(eD(t.y,0,o)),l.push(eR(t.angle)),l.push(eD(t.lives,0,3)),l.push(eD(a.x,0,n)),l.push(eD(a.y,0,o)),l.push(eR(a.angle)),l.push(eD(a.lives,0,3));let d=a.x-t.x,c=a.y-t.y,h=Math.sqrt(d*d+c*c),u=Math.sqrt(n*n+o*o);l.push(eD(d,-n,n)),l.push(eD(c,-o,o)),l.push(eD(h,0,u));let g=function(e){for(;e>180;)e-=360;for(;e<-180;)e+=360;return e/180}(180*Math.atan2(c,d)/Math.PI-t.angle);l.push(g);let m=[];for(let e=0;e<i.length&&m.length<20;e++){let t=i[e];t.exploding||m.push(t)}for(let e=0;e<20;e++)if(e<m.length){let a=m[e];l.push(eD(a.x,0,n)),l.push(eD(a.y,0,o)),l.push(eD(a.vx,-(2*V),2*V)),l.push(eD(a.vy,-(2*V),2*V)),l.push(+(a.owner===t.color))}else l.push(0,0,0,0,0);let p=(s||[]).slice(0,10);for(let e=0;e<10;e++)if(e<p.length){let t=p[e];l.push(eD(t.x,0,n)),l.push(eD(t.y,0,o)),l.push(eD(t.size,0,100))}else l.push(0,0,0);let f=function(e,t,a,i,s){let r=((null===eE||eA!==a)&&(eE=a.map(e=>({left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height})),eA=a),eE),n=Math.max(i,s);return[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}].map(a=>{let o=0;for(;o<n;){let n=e+a.dx*o,l=t+a.dy*o;if(n<0||n>i||l<0||l>s)break;let d=!1;for(let e of r)if(n>=e.left&&n<=e.right&&l>=e.top&&l<=e.bottom){d=!0;break}if(d)break;o+=5}return o})}(t.x+O/2,t.y+O/2,r,n,o);return l.push(...f.map(e=>eD(e,0,Math.max(n,o)))),l.push(eD(e.tickTime%1e4,0,1e4)),l.push(eD(n,0,2e3)),{vector:l,size:l.length}}function eD(e,t,a){return a===t?.5:Math.max(0,Math.min(1,(e-t)/(a-t)))}function eR(e){let t=e%360;return t<0&&(t+=360),t/360}class eI{loaded=!0;isLoaded(){return this.loaded}async load(e){this.loaded=!0}async predict(e,t){e.vector[4],e.vector[5];let a=e.vector[11],i=0,s=0,r=!1;return Math.abs(a)>.1&&(i=a>0?5:-5),.2>Math.abs(a)&&(s=1,r=!0),{angleDelta:i,moveDirection:s,shouldShoot:r}}getInfo(){return{name:"Rule-Based Fallback",type:"discrete",observationSize:152,actionSize:eM}}}class eL{loaded=!1;model=null;info;constructor(e){this.info=e}isLoaded(){return this.loaded&&null!==this.model}async load(e){try{this.loaded=!1}catch(e){throw this.loaded=!1,e}}async predict(e,t){if(!this.isLoaded())throw Error("Model not loaded");throw Error("TensorFlow.js prediction not yet implemented")}getInfo(){return this.info}}let eC=new class{model=null;fallbackModel;constructor(){this.fallbackModel=new eI}setModel(e){this.model=e}getModel(){return this.model&&this.model.isLoaded()?this.model:this.fallbackModel}isRLActive(){return null!==this.model&&this.model.isLoaded()}async loadModel(e){if(!this.model)throw Error("No model set. Call setModel() first.");await this.model.load(e)}};async function eB(e){let{aiTank:t,enemyTank:a,bullets:i,barriers:s,suns:r,mapWidth:n,mapHeight:o,tickTime:l,config:d}=e;if(t.respawning||t.exploding||t.lives<=0)return{angleDelta:0,moveDirection:0,shouldShoot:!1};if(eC.isRLActive())try{let a=eC.getModel(),i=eP(e);return await a.predict(i,t.angle)}catch(e){}return function(e){let{aiTank:t,enemyTank:a,bullets:i,barriers:s,suns:r,mapWidth:n,mapHeight:o,config:l}=e,d=function(e,t,a,i,s,r,n){let o=[];for(let l of t){if(l.owner===e.color||l.exploding)continue;let t=eS(l,a,i,s,r,n,16),d=1/0,c=0,h={x:l.x,y:l.y},u=eg(e),g=G+5;for(let e of t.points){let t=el(e.x,e.y,u.x,u.y);if(t<g){d=t,c=e.time,h={x:e.x,y:e.y};break}t<d&&(d=t,c=e.time,h={x:e.x,y:e.y})}let m=3*G;if(d<m){let e=(Math.max(0,1-c/n)+Math.max(0,1-d/m))/2;o.push({bullet:l,timeToCollision:c,closestDistance:d,collisionPoint:h,threatLevel:Math.min(1,e)})}}return o.sort((e,t)=>t.threatLevel-e.threatLevel),o}(t,i,r,s,n,o,l.maxPredictionTime);return d.length>0&&d[0].threatLevel>.85?function(e,t){let{aiTank:a,enemyTank:i,barriers:s,suns:r,mapWidth:n,mapHeight:o,config:l,bullets:d}=e,c=function(e,t,a,i,s,r){if(0===t.length)return{angle:e.angle,urgency:0};let n=t[0];if(n.threatLevel<.5)return{angle:e.angle,urgency:n.threatLevel};let o=eg(e);return 1>el(o.x,o.y,n.collisionPoint.x,n.collisionPoint.y)?{angle:(e.angle+90)%360,urgency:1}:{angle:eh(n.collisionPoint,o),urgency:n.threatLevel}}(a,t,0,0,0,0),h=function e(t,a,i,s,r,n,o,l,d){let c=a*Math.PI/180,h=t.x+Math.cos(c)*i,u=t.y+Math.sin(c)*i;if(eo(h,u,o,l,s,n,r,d))return{x:h,y:u};for(let e of[(a+90)%360,(a-90+360)%360]){let a=e*Math.PI/180,c=t.x+Math.cos(a)*i,h=t.y+Math.sin(a)*i;if(eo(c,h,o,l,s,n,r,d))return{x:c,y:h}}return i>20?e(t,a,.5*i,s,r,n,o,l,d):null}(a,c.angle,2*l.dodgeMargin,s,r,[a,i],n,o,1),u=0,g=0;if(h){let e=ec(eh(eg(a),h)-a.angle);u=Math.abs(e)>Q?e>0?Q:-Q:e,g=1}else{let e=ec(c.angle-a.angle);u=Math.abs(e)>Q?e>0?Q:-Q:e,g=-1}return{angleDelta:u,moveDirection:g,shouldShoot:!1}}(e,d):function(e){let t,a,i,s,{aiTank:r,enemyTank:n,bullets:o,barriers:l,suns:d,mapWidth:c,mapHeight:h,tickTime:u,config:g}=e,m=function(e,t,a,i,s,r,n){let o=180*Math.atan2(t.y-(e.y+O/2),t.x-(e.x+O/2))/Math.PI,l=o*Math.PI/180,d=eS({x:e.x+O/2+Math.cos(l)*(O/2+T),y:e.y+O/2+Math.sin(l)*(O/2+T),angle:o,speed:V,owner:e.color,createdAt:0,vx:Math.cos(l)*V,vy:Math.sin(l)*V},a,i,s,r,3e3,Y),c=0;for(let e of d.points){let a=e.x-t.x,i=e.y-t.y;if(15>Math.sqrt(a*a+i*i)){c=.8;break}}let h=function(e,t,a,i,s,r,n){if(n<.3||0===a.length)return null;let o=null,l=0;for(let d of a)for(let d=0;d<16;d++){let c=180*Math.atan2(t.y-(e.y+O/2),t.x-(e.x+O/2))/Math.PI+(d/15-.5)*60,h=c*Math.PI/180,u=eS({x:e.x+O/2+Math.cos(h)*(O/2+T),y:e.y+O/2+Math.sin(h)*(O/2+T),angle:c,speed:V,owner:e.color,createdAt:0,vx:Math.cos(h)*V,vy:Math.sin(h)*V},a,i,s,r,3e3,Y),g=1/0,m=0;for(let e of u.points){let a=e.x-t.x,i=e.y-t.y,s=Math.sqrt(a*a+i*i);if(s<g&&(g=s,m=e.time),s<15){let e=n*(1-Math.min(g/30,1));e>l&&(l=e,o={angle:c,confidence:e,timeToHit:m,usesSun:!0})}}}return o}(e,t,a,i,s,r,n);return h&&h.confidence>c?h:{angle:o,confidence:c,timeToHit:1e3,usesSun:!1}}(r,(i=Math.cos(a=n.angle*Math.PI/180)*H*(500/Y),s=Math.sin(a)*H*(500/Y),{x:n.x+i,y:n.y+s}),d,l,c,h,g.sunSkill);!function(e,t,a,i,s,r,n){let o=e.x+12,l=e.y+12,d=t.x+12,c=t.y+12,h=d-o,u=c-l,g=Math.sqrt(h*h+u*u),m=180*Math.atan2(u,h)/Math.PI,p=d,f=c;if(g>30){let e=Math.min(.8*g,50+(1-a)*50);p=d-Math.cos(m*Math.PI/180)*e,f=c-Math.sin(m*Math.PI/180)*e}else p=o,f=l;let x=(p=Math.max(12,Math.min(p,r-12)))-o;f=Math.max(12,Math.min(f,n-12))}(r,n,g.aggressiveness,0,0,c,h);let p=0,f=0,x=ec(m.angle-r.angle);p=Math.abs(x)>Q?x>0?Q:-Q:x;let y=ec(eh(eg(r),eg(n))-r.angle);f=60>Math.abs(y)?1:Math.abs(y)>120?-1:1;let v=!1;return(ep(o).get(r.color)||0)<J&&m.confidence>.2-g.accuracyPenalty&&m.confidence*(1-g.accuracyPenalty)>.15&&45>Math.abs(x)&&(v=!0,t=m.angle),{angleDelta:p,moveDirection:f,shouldShoot:v,shootAngle:t}}(e)}(e)}let eF={reactionDelay:30,accuracyPenalty:.08,aggressiveness:.85,sunSkill:.65,maxPredictionTime:3e3,dodgeMargin:25},ez={timeoutPenalty:-100,maxEpisodeTimeMs:6e4,survivalRewardPerTick:.01,hitEnemyReward:100,gotHitPenalty:-100,optimalDistanceToEnemy:120,inactivityThresholdMs:1500,significantMovementThreshold:5,aggressionCheckIntervalMs:2e3,dodgeRewardPerBullet:10,recentBulletThresholdMs:100,positionHistorySize:10,positionRepeatThreshold:30,threatDistance:50,bulletMatchDistance:10,movementAwayThreshold:10,shotAccuracyMaxDistance:50,movementRewardMax:.15,movementRewardMultiplier:.0015,stagnationPenalty:-.1,stalematePenalty:-.2,repetitiveActionPenalty:-.03,positionDiversityReward:.02,lifeAdvantageReward:.02,inactivityBasePenalty:-.3,inactivityMaxPenalty:-.5,inactivityScalingFactor:.1,lackOfAggressionPenalty:-.15};function e$(e,t){return el(e.x,e.y,t.x,t.y)}function eq(e,t){let a=eg(t);return el(e.x,e.y,a.x,a.y)}class eW{previousState=null;episodeStartTime=0;episodeLength=0;totalReward=0;positionHistory=[];maxEpisodeTimeMs;constructor(e=6e4){this.maxEpisodeTimeMs=e}reset(e){let t=eP(e);return this.positionHistory=[{x:e.aiTank.x,y:e.aiTank.y,tickTime:e.tickTime}],this.episodeStartTime=e.tickTime,this.previousState={aiTank:{...e.aiTank},enemyTank:{...e.enemyTank},bullets:e.bullets.map(e=>({...e})),aiLives:e.aiTank.lives,enemyLives:e.enemyTank.lives,tickTime:e.tickTime,aiPositionHistory:[],lastMovementTime:e.tickTime,lastShotTime:0,episodeStartTime:e.tickTime,timeoutApplied:!1},this.episodeLength=0,this.totalReward=0,{observation:t,reward:0,done:!1,info:{episodeLength:0,totalReward:0,aiLives:e.aiTank.lives,enemyLives:e.enemyTank.lives}}}step(e,t,a){if(!this.previousState)return this.reset(t);let i=function(e,t,a,i=6e4,s=ez){let r=0,n={};if(e.episodeStartTime&&!e.timeoutApplied&&t.tickTime-e.episodeStartTime>=i){let e=s.timeoutPenalty;r+=e,n.timeoutPenalty=e}let o=s.survivalRewardPerTick;if(r+=o,n.survival=o,t.enemyLives<e.enemyLives){let e=s.hitEnemyReward;r+=e,n.hitEnemy=e}if(t.aiLives<e.aiLives){let e=s.gotHitPenalty;r+=e,n.gotHit=e}let l=e$(e.aiTank,e.enemyTank),d=e$(t.aiTank,t.enemyTank),c=s.optimalDistanceToEnemy,h=2*(Math.abs(l-c)/c-Math.abs(d-c)/c);r+=h,n.distanceReward=h;let u=function(e,t,a){let i=a.threatDistance,s=a.bulletMatchDistance,r=[];for(let t of e.bullets)t.owner!==e.aiTank.color&&!t.exploding&&eq(t,e.aiTank)<i&&r.push(t);let n=new Map;for(let e of t.bullets)if(!e.exploding){let t=n.get(e.owner)||[];t.push(e),n.set(e.owner,t)}let o=0,l=eg(t.aiTank);for(let e of r){let t=n.get(e.owner)||[],a=!1;for(let i of t)if(el(i.x,i.y,e.x,e.y)<s){a=!0;break}if(!a){let e=1/0;for(let a of t){let t=el(a.x,a.y,l.x,l.y);t<e&&(e=t)}e>i&&o++}}return o*a.dodgeRewardPerBullet}(e,t,s);if(u>0&&(r+=u,n.dodgedBullet=u),a.shouldShoot){let e=s.recentBulletThresholdMs;for(let a of t.bullets)if(a.owner===t.aiTank.color&&t.tickTime-a.createdAt<e){let e=Math.max(0,5*(1-eq(a,t.enemyTank)/s.shotAccuracyMaxDistance));r+=e,n.shotAccuracy=(n.shotAccuracy||0)+e}}if(e.aiLives,e.enemyLives,t.aiLives-t.enemyLives>0){let e=s.lifeAdvantageReward;r+=e,n.lifeAdvantage=e}let g=e$(e.aiTank,t.aiTank),m=g>.1;if(m){let e=Math.min(s.movementRewardMax,g*s.movementRewardMultiplier);r+=e,n.movement=e}else{let e=s.stagnationPenalty;r+=e,n.stagnationPenalty=e,n.movement=e}if(5>Math.abs(e$(t.aiTank,t.enemyTank)-e$(e.aiTank,e.enemyTank))&&g<2){let e=s.stalematePenalty;r+=e,n.stalematePenalty=e}if(a.shouldShoot&&!m&&t.bullets.length>=e.bullets.length){let e=s.repetitiveActionPenalty;r+=e,n.repetitiveActionPenalty=e}if(e.aiPositionHistory&&e.aiPositionHistory.length>0){let a=s.positionRepeatThreshold,i=s.positionHistorySize,o=Math.max(0,e.aiPositionHistory.length-i),l={x:t.aiTank.x,y:t.aiTank.y},d=!1;for(let t=o;t<e.aiPositionHistory.length;t++){let i=e.aiPositionHistory[t];if(el(l.x,l.y,i.x,i.y)<a){d=!0;break}}if(!d&&m){let e=s.positionDiversityReward;r+=e,n.movement=(n.movement||0)+e}}let p=s.inactivityThresholdMs,f=s.significantMovementThreshold;if(m&&g>=f);else{let a=e.lastMovementTime||e.episodeStartTime||e.tickTime,i=t.tickTime-a;if(i>=p){let e=Math.min(s.inactivityMaxPenalty,s.inactivityBasePenalty-(i-p)/1e3*s.inactivityScalingFactor);r+=e,n.inactivityPenalty=e}}let x=s.aggressionCheckIntervalMs,y=(e.lastShotTime?t.tickTime-e.lastShotTime:1/0)>x&&!a.shouldShoot&&g<2,v=d-l>s.movementAwayThreshold;if(y||v&&!a.shouldShoot){let e=s.lackOfAggressionPenalty;r+=e,n.lackOfAggressionPenalty=e}return{reward:r,breakdown:n}}(this.previousState,{aiTank:t.aiTank,enemyTank:t.enemyTank,bullets:t.bullets,aiLives:t.aiTank.lives,enemyLives:t.enemyTank.lives,tickTime:t.tickTime},a,this.maxEpisodeTimeMs,ez);this.totalReward+=i.reward,this.episodeLength++;let s=this.isDone(t),r=eP(t);this.positionHistory.push({x:t.aiTank.x,y:t.aiTank.y,tickTime:t.tickTime}),this.positionHistory.length>20&&this.positionHistory.shift();let n=Math.sqrt(Math.pow(t.aiTank.x-this.previousState.aiTank.x,2)+Math.pow(t.aiTank.y-this.previousState.aiTank.y,2))>=5?t.tickTime:this.previousState.lastMovementTime||t.tickTime,o=a.shouldShoot?t.tickTime:this.previousState.lastShotTime||0,l=t.tickTime-this.episodeStartTime>=this.maxEpisodeTimeMs&&!this.previousState?.timeoutApplied;return this.previousState={aiTank:{...t.aiTank},enemyTank:{...t.enemyTank},bullets:t.bullets.map(e=>({...e})),aiLives:t.aiTank.lives,enemyLives:t.enemyTank.lives,tickTime:t.tickTime,aiPositionHistory:[...this.positionHistory],lastMovementTime:n,lastShotTime:o,episodeStartTime:this.episodeStartTime,timeoutApplied:l||this.previousState?.timeoutApplied||!1},{observation:r,reward:i.reward,done:s,info:{episodeLength:this.episodeLength,totalReward:this.totalReward,aiLives:t.aiTank.lives,enemyLives:t.enemyTank.lives,...i.breakdown}}}getObservation(e){return eP(e)}isDone(e){return!!(e.aiTank.lives<=0)||!!(e.enemyTank.lives<=0)||!!(e.tickTime-this.episodeStartTime>=this.maxEpisodeTimeMs)}getStats(){return{episodeLength:this.episodeLength,totalReward:this.totalReward}}}async function eO(e,t=eF,a,i){let s,{tank:r,tankIndex:n,tickTime:o,lastShotTime:l,bullets:d,mapWidth:c,mapHeight:h,barriers:u,suns:g,allTanks:m}=e;if(m.length>=2&&void 0!==n){let e=+(0===n);(s=m[e])&&!(s.lives<=0)||(s=m[+(0===e)]||s)}else s=m.find(e=>e&&e.color!==r.color&&e.lives>0)||m.find(e=>e&&e!==r);s||(s={x:c/2,y:h/2,angle:0,lives:3,color:"blue"===r.color?"red":"blue"});let p={aiTank:r,enemyTank:s,bullets:d,barriers:u,suns:g,mapWidth:c,mapHeight:h,tickTime:o,config:t},f=await eB(p);a&&a.getIsTraining()&&a.step(p,f,void 0,i).catch(()=>{});let x=r.angle+f.angleDelta,y=r.x,v=r.y,w=[],b=l;if(0!==f.moveDirection){let e=x*er,t=f.moveDirection>0?H:-(.7*H),a=y+Math.cos(e)*t,i=v+Math.sin(e)*t;eo(a,i,c,h,u,m,g,n)&&(y=a,v=i)}if(f.shouldShoot&&o-l>A&&(ep(d).get(r.color)||0)<J){let e=f.shootAngle??x,t=eu({...r,x:y,y:v,angle:e},e,o,r.color);w.push(t),b=o}let T=em(y,v,c,h);return y=T.x,v=T.y,{updatedTank:{...r,x:y,y:v,angle:x},newBullets:w,lastShotTime:b,decision:f}}function eG({mapData:e,barriers:t,suns:a,aiConfig:i,trainingManager:r,maxEpisodeTimeMs:n=6e4,gameInstances:o,onTanksUpdate:l,onBulletsUpdate:d,onLastShotTimesUpdate:c,onGameOver:h}){let u=(0,s.useRef)(new Map),g=(0,s.useRef)(new Map),m=(0,s.useRef)(new Map),p=(0,s.useRef)(new Map),f=(0,s.useRef)(o),x=(0,s.useRef)(new Map);return(0,s.useEffect)(()=>{f.current=o;let e=new Map;o.forEach(t=>{e.set(t.id,t)}),x.current=e},[o]),(0,s.useEffect)(()=>{o.forEach(e=>{m.current.has(e.id)||m.current.set(e.id,e.tanks),p.current.has(e.id)||p.current.set(e.id,e.bullets)})},[o]),(0,s.useEffect)(()=>{o.forEach(e=>{m.current.get(e.id),m.current.set(e.id,e.tanks),p.current.set(e.id,e.bullets),e.tanks.length>=2&&e.tanks[0]?.lives===b&&e.tanks[1]?.lives===b&&u.current.set(e.id,!1)})},[o]),{gameTick:(0,s.useCallback)(async s=>{let o,y=f.current;for(let f of s?.gameId!==void 0?(o=x.current.get(s.gameId))?[o]:[]:y){if(f.isPaused)continue;let o=Date.now(),x=g.current.get(f.id)||0;if(!s?.skipIntervalCheck&&o-x<Y/f.speedMultiplier)return;g.current.set(f.id,o);let y=[...m.current.get(f.id)||[]],v=[...p.current.get(f.id)||[]],w={...f.lastShotTimes},b=f.keysRef.current;if(!y||y.length<2)continue;if(y[0]?.lives>0){let s;s="person-vs-ai"===f.gameMode?ef({tank:y[0],tankIndex:0,keys:b,tickTime:o,lastShotTime:f.lastShotTimes.blue,bullets:v,mapWidth:e.width,mapHeight:e.height,barriers:t,suns:a,allTanks:y}):r&&r.getIsTraining()&&"ai"===f.gameMode?await eO({tank:y[0],tankIndex:0,keys:b,tickTime:o,lastShotTime:f.lastShotTimes.blue,bullets:v,mapWidth:e.width,mapHeight:e.height,barriers:t,suns:a,allTanks:y},i,r,`${f.gameId}-blue`):ef({tank:y[0],tankIndex:0,keys:b,tickTime:o,lastShotTime:f.lastShotTimes.blue,bullets:v,mapWidth:e.width,mapHeight:e.height,barriers:t,suns:a,allTanks:y}),y[0]=s.updatedTank,v.push(...s.newBullets),w.blue=s.lastShotTime}if(y[1]?.lives>0){let s=await eO({tank:y[1],tankIndex:1,keys:b,tickTime:o,lastShotTime:f.lastShotTimes.red,bullets:v,mapWidth:e.width,mapHeight:e.height,barriers:t,suns:a,allTanks:y},i,r,f.gameId);y[1]=s.updatedTank,v.push(...s.newBullets),w.red=s.lastShotTime}let T=function(e){let t,{bullets:a,tickTime:i,mapWidth:s,mapHeight:r,barriers:n,suns:o,tanks:l}=e,d=[],c=[...l],h=j,u=function(e){let t=new Map;for(let a=0;a<e.length;a++){let i=e[a];if(i.exploding)continue;let s=t.get(i.owner)||[];s.push(a),t.set(i.owner,s)}return t}(a),g=function(e,t){let a=new Set,i=new Set,s=j,r=t.get("blue")||[],n=t.get("red")||[];for(let t of r){if(a.has(t))continue;let r=e[t];if(!r.exploding)for(let o of n){if(a.has(o))continue;let n=e[o];if(n.exploding)continue;let l=`${Math.min(t,o)}-${Math.max(t,o)}`;if(!i.has(l)&&(i.add(l),el(r.x,r.y,n.x,n.y)<s)){a.add(t),a.add(o);break}}}return a}(a,u),m=(t=W,(null===ex||ey!==o||ev!==t)&&(ex=t?[]:o.map(e=>({x:e.x,y:e.y})),ey=o,ev=t),ex),p=((null===ew||eb!==V)&&(ew={gravitationalConstant:X,sourceMass:K,influenceRadius:Z,minDistance:I,maxAcceleration:.3*V},eb=V),ew);for(let e=0;e<a.length;e++){if(g.has(e))continue;let t=a[e];if(t.exploding)continue;let o=i-t.createdAt;if(o>_&&o>_+M)continue;let l=W?{x:0,y:0}:ei({x:t.x,y:t.y},m,p),u=t.vx+l.x,f=t.vy+l.y,x=es({x:u,y:f},.5);u=x.x,f=x.y;let y=t.x+u,v=t.y+f,w=et({x:y,y:v},{x:u,y:f},h,{left:0,right:s,top:0,bottom:r});for(let e of(y=w.newPosition.x,v=w.newPosition.y,u=w.newVelocity.x,f=w.newVelocity.y,n)){let a=ea({x:y,y:v},{x:u,y:f},h,{x:e.x,y:e.y,width:e.width,height:e.height},{x:t.x,y:t.y});if(a.bounced){y=a.newPosition.x,v=a.newPosition.y,u=a.newVelocity.x,f=a.newVelocity.y;break}}let b=!1;for(let e=0;e<c.length;e++){let t=c[e];if(t.lives>0){if(void 0!==t.invincibleUntil&&i<t.invincibleUntil)continue;let a=y-h/2,s=v-h/2,r=y+h/2,n=v+h/2,o=(O-G)/2,l=t.x+o,d=t.y+o,u=l+G,g=d+G;if(a<u&&r>l&&s<g&&n>d){let a=t.lives-1;c[e]={...t,lives:a},b=!0;break}}}if(b)continue;let T=Math.atan2(f,u)*en;d.push({...t,x:y,y:v,angle:T,vx:u,vy:f})}return{updatedBullets:d,updatedTanks:c}}({bullets:v,tickTime:o,mapWidth:e.width,mapHeight:e.height,barriers:t,suns:a,tanks:y}),k=u.current.get(f.id)||!1;if(!k&&f.episodeStartTime&&o-f.episodeStartTime>=n){u.current.set(f.id,!0);let e=T.updatedTanks[0],t=T.updatedTanks[1],a=null;e&&t&&(e.lives>t.lives?a="blue":t.lives>e.lives&&(a="red")),T.updatedBullets=[],T.updatedTanks[0]={...e,exploding:!1,explosionStartTime:void 0,respawning:!1,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0,invincibleUntil:void 0},T.updatedTanks[1]={...t,exploding:!1,explosionStartTime:void 0,respawning:!1,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0,invincibleUntil:void 0},l(f.id,T.updatedTanks),d(f.id,T.updatedBullets),h(f.id,a);return}let S=T.updatedTanks[0],N=T.updatedTanks[1];if(!k&&S&&N&&(S.lives<=0||N.lives<=0)){u.current.set(f.id,!0);let e=S.lives<=0?"red":"blue";T.updatedBullets=[],T.updatedTanks[0]={...S,exploding:!1,explosionStartTime:void 0,respawning:!1,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0,invincibleUntil:void 0},T.updatedTanks[1]={...N,exploding:!1,explosionStartTime:void 0,respawning:!1,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0,invincibleUntil:void 0},l(f.id,T.updatedTanks),d(f.id,T.updatedBullets),h(f.id,e);return}for(let i=0;i<T.updatedTanks.length;i++){let s=T.updatedTanks[i],r=y[i];if(s.lives<r.lives&&s.lives>0){let r=s.color,n=[];for(let e of T.updatedBullets)e.owner!==r&&n.push(e);T.updatedBullets=n;let l=eT(e,t,T.updatedTanks,a,0===i?T.updatedTanks[1]:T.updatedTanks[0]?{x:T.updatedTanks[+(0===i)].x,y:T.updatedTanks[+(0===i)].y}:void 0);T.updatedTanks[i]={...s,x:l.x,y:l.y,angle:l.angle,exploding:!1,explosionStartTime:void 0,respawning:!1,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0,invincibleUntil:o+2e3}}(s.exploding||s.respawning)&&(T.updatedTanks[i]={...s,exploding:!1,explosionStartTime:void 0,respawning:!1,respawnStartTime:void 0,respawnTargetX:void 0,respawnTargetY:void 0,respawnTargetAngle:void 0}),void 0!==s.invincibleUntil&&o>=s.invincibleUntil&&(T.updatedTanks[i]={...s,invincibleUntil:void 0})}k||(l(f.id,T.updatedTanks),d(f.id,T.updatedBullets),c(f.id,w))}},[e,t,a,i,r,n,l,d,c,h])}}function eU({width:e,height:t,tanks:a,bullets:r,barriers:n,suns:o,isPaused:l,tankImages:d,gameOverWinner:c,scale:h=1}){let u=(0,s.useRef)(null);(0,s.useEffect)(()=>{let e=u.current;if(e){e.focus();let t=()=>{e.focus()};return e.addEventListener("click",t),()=>{e.removeEventListener("click",t)}}},[]),(0,s.useEffect)(()=>{let i=u.current;if(!i)return;let s=i.getContext("2d");if(!s)return;for(let a of(i.width=2*e,i.height=2*t,s.setTransform(1,0,0,1,0,0),s.scale(2,2),s.clearRect(0,0,e,t),s.fillStyle="#2D3748",s.fillRect(0,0,e,t),s.fillStyle="#4A5568",n))s.fillRect(a.x,a.y,a.width,a.height);if(!W)for(let e of(s.strokeStyle="rgba(98, 156, 119, 0.3)",s.fillStyle="rgba(98, 156, 119, 0.3)",s.lineWidth=.5,o))for(let t=e.x-Z;t<=e.x+Z;t+=30)for(let a=e.y-Z;a<=e.y+Z;a+=30){let i=e.x-t,r=e.y-a,n=Math.sqrt(i*i+r*r);if(n>e.size+5&&n<Z){let e=Math.atan2(r,i),o=i/n,l=r/n;s.beginPath(),s.moveTo(t,a),s.lineTo(t+8*o,a+8*l),s.stroke(),s.save(),s.translate(t+8*o,a+8*l),s.rotate(e),s.beginPath(),s.moveTo(0,0),s.lineTo(-3,-1.5),s.lineTo(-3,1.5),s.closePath(),s.fill(),s.restore()}}if(!W)for(let e of o){let t=s.createRadialGradient(e.x,e.y,0,e.x,e.y,e.size);t.addColorStop(0,"rgba(98, 156, 119, 0.9)"),t.addColorStop(.7,"rgba(98, 156, 119, 0.75)"),t.addColorStop(1,"rgba(98, 156, 119, 0)"),s.fillStyle=t,s.beginPath(),s.arc(e.x,e.y,e.size,0,2*Math.PI),s.fill(),s.strokeStyle="rgba(98, 156, 119, 0.5)",s.lineWidth=1,s.stroke()}for(let e of a.length>=2?[a[0],a[1]]:a.slice(0,2)){if(e.lives<=0||void 0===e.x||void 0===e.y)continue;if(s.save(),void 0!==e.invincibleUntil&&Date.now()<e.invincibleUntil){let t=e.x+O/2,a=e.y+O/2,i=O/2+3;s.beginPath(),s.arc(t,a,i,0,2*Math.PI),s.strokeStyle="#FFD700",s.lineWidth=1,s.stroke()}s.translate(e.x+O/2,e.y+O/2),s.rotate(e.angle*Math.PI/180),s.translate(-O/2,-O/2);let t="blue"===e.color?d.blue:d.red;t?s.drawImage(t,0,0,O,O):(s.fillStyle="blue"===e.color?"#3B82F6":"#EF4444",s.fillRect(0,0,O,O),s.strokeStyle="blue"===e.color?"#1E40AF":"#DC2626",s.lineWidth=1,s.strokeRect(0,0,O,O)),s.restore(),s.fillStyle="blue"===e.color?"#3B82F6":"#EF4444";for(let t=0;t<e.lives;t++)s.beginPath(),s.arc(e.x+B+t*C,e.y+F,L,0,2*Math.PI),s.fill()}for(let e of r){if(e.exploding)continue;let t=Date.now()-e.createdAt,a=M,i=1;if(t>_&&(i=Math.max(0,1-(t-_)/a)),i>0){let t="blue"===e.owner?59:239,a="blue"===e.owner?130:68,r="blue"===e.owner?246:68;s.save(),s.globalAlpha=i;let n=e.angle*Math.PI/180;s.translate(e.x,e.y),s.rotate(n);s.fillStyle=`rgb(${t}, ${a}, ${r})`,s.beginPath(),s.moveTo(-2,-1.5),s.lineTo(2,-1.5),s.quadraticCurveTo(3,-1.5,3,-.5),s.lineTo(3,.5),s.quadraticCurveTo(3,1.5,2,1.5),s.lineTo(-2,1.5),s.quadraticCurveTo(-3,1.5,-3,.5),s.lineTo(-3,-.5),s.quadraticCurveTo(-3,-1.5,-2,-1.5),s.closePath(),s.fill(),s.restore()}}s.textAlign="right",s.fillStyle="rgba(255, 255, 255, 0.8)",s.font=`${z-1}px Inter`;let h=q,g=e-$;s.fillText("Player 1 (Blue): Arrows + Space",g,h),s.fillText("Player 2 (Red): WASD + Q",g,h+12),s.textAlign="left",c&&(s.fillStyle="rgba(0, 0, 0, 0.8)",s.fillRect(0,0,e,t),s.fillStyle="#FFFFFF",s.font="bold 32px Inter",s.textAlign="center",s.fillText("blue"===c?"BLUE WINS!":"RED WINS!",e/2,t/2-20),s.font="20px Inter",s.fillText("Press any key to play again",e/2,t/2+20),s.textAlign="left"),l&&!c&&(s.fillStyle="rgba(0, 0, 0, 0.7)",s.fillRect(0,0,e,t),s.fillStyle="#FFFFFF",s.font="bold 48px Inter",s.textAlign="center",s.fillText("PAUSED",e/2,t/2),s.textAlign="left")},[e,t,a,r,n,o,l,d,c]);let g=2*e*h,m=2*t*h;return(0,i.jsx)("canvas",{ref:u,className:"border-2 border-[#4A5568] rounded outline-none",style:{width:`${g}px`,height:`${m}px`,display:"block"},tabIndex:0,onFocus:e=>e.target.focus()})}e.i(40325),e.i(38799),e.i(59230),e.i(25911);var eH=e.i(21732);e.i(96141),e.i(56037),e.i(60507),e.i(97545),e.i(7147),e.i(2419),e.i(92455);var eV=e.i(14118),eQ=e.i(42475);e.i(67727),e.i(28834),e.i(80306);var eV=eV,eY=e.i(16749),eJ=e.i(3901),e_=e.i(60233),eX=e.i(14551),eK=e.i(50234);let eZ={observationSize:152,actionSize:eM,learningRate:.001,hiddenLayers:[128,128,64],gamma:.99,epsilonStart:1,epsilonEnd:.01,epsilonDecay:.995,batchSize:32,replayBufferSize:1e4,targetUpdateFrequency:100};class e0{qNetwork=null;targetNetwork=null;config;epsilon;stepCount=0;trainingInProgress=null;isDisposed=!1;constructor(e={}){this.config={...eZ,...e},this.epsilon=this.config.epsilonStart}async initialize(){this.qNetwork=this.createNetwork(),this.targetNetwork=this.createNetwork(),this.updateTargetNetwork()}createNetwork(){let e=eV.sequential();e.add(eH.dense({inputShape:[this.config.observationSize],units:this.config.hiddenLayers[0],activation:"relu",kernelInitializer:"heNormal"}));for(let t=1;t<this.config.hiddenLayers.length;t++)e.add(eH.dense({units:this.config.hiddenLayers[t],activation:"relu",kernelInitializer:"heNormal"}));return e.add(eH.dense({units:this.config.actionSize,activation:"linear",kernelInitializer:"zeros"})),e.compile({optimizer:eY.train.adam(this.config.learningRate),loss:"meanSquaredError"}),e}areNetworksValid(){return!this.isDisposed&&null!==this.qNetwork&&null!==this.targetNetwork}async selectAction(e,t=!0){if(!this.qNetwork)throw Error("Network not initialized. Call initialize() first.");if(t&&Math.random()<this.epsilon)return Math.floor(Math.random()*this.config.actionSize);let a=eJ.tensor2d([e.vector]),i=n(this.qNetwork.predict(a),e=>e instanceof e_.Tensor,"Expected Tensor from predict"),s=await i.data();a.dispose(),i.dispose();let r=0,o=s[0];for(let e=1;e<s.length;e++)s[e]>o&&(o=s[e],r=e);return r}async predict(e,t){var a=await this.selectAction(e,!1);let i={angleDelta:0,moveDirection:0,shouldShoot:!1};switch(a){case 0:break;case 1:i.angleDelta=-Q;break;case 2:i.angleDelta=Q;break;case 3:i.moveDirection=1;break;case 4:i.moveDirection=-1;break;case 5:i.shouldShoot=!0;break;case 6:i.angleDelta=-Q,i.moveDirection=1;break;case 7:i.angleDelta=Q,i.moveDirection=1;break;case 8:i.angleDelta=-Q,i.shouldShoot=!0;break;case 9:i.angleDelta=Q,i.shouldShoot=!0;break;case 10:i.moveDirection=1,i.shouldShoot=!0;break;case 11:i.moveDirection=-1,i.shouldShoot=!0;break;case 12:i.angleDelta=-Q,i.moveDirection=-1;break;case 13:i.angleDelta=Q,i.moveDirection=-1}return i}async train(e){let t,a;if(!this.areNetworksValid()||0===e.length)return 0;if(this.trainingInProgress){try{await this.trainingInProgress}catch(e){}return 0}this.trainingInProgress=new Promise((e,i)=>{t=e,a=i}),this.executeTraining(e,this.trainingInProgress).then(e=>{this.trainingInProgress=null,t&&t(e)}).catch(e=>{this.trainingInProgress=null,a&&a(e)});try{return await this.trainingInProgress}catch(e){return 0}}async executeTraining(e,t){let a=Math.min(e.length,this.config.batchSize),i=[],s=[],r=[],o=[],l=[];for(let t=0;t<a;t++){let a=e[t];i.push(a.state),s.push(a.action),r.push(a.reward),o.push(a.nextState),l.push(a.done)}let d=eJ.tensor2d(i),u=eJ.tensor2d(o),g=[d,u];try{if(!this.areNetworksValid()||this.trainingInProgress!==t)return 0;if(!this.qNetwork||!this.targetNetwork)throw Error("Networks not initialized");let e=this.qNetwork.predict(d),i=this.targetNetwork.predict(u),o=n(e,e=>e instanceof e_.Tensor,"Expected Tensor from predict"),h=n(i,e=>e instanceof e_.Tensor,"Expected Tensor from predict");g.push(o,h);let m=await o.array(),p=await h.array(),f=n(m,c,"Expected 2D number array from tensor.array()"),x=n(p,c,"Expected 2D number array from tensor.array()");if(!this.areNetworksValid()||this.trainingInProgress!==t)return 0;let y=[];for(let e=0;e<a;e++){let t=[...f[e]],a=Math.max(...x[e]),i=r[e]+(l[e]?0:this.config.gamma*a);t[s[e]]=i,y.push(t)}let v=eJ.tensor2d(y);if(g.push(v),!this.areNetworksValid()||this.trainingInProgress!==t)return 0;if(!this.qNetwork)throw Error("Network not initialized");let w=await this.qNetwork.fit(d,v,{epochs:1,verbose:0,batchSize:a}),b=0;if(Array.isArray(w.history.loss)){let e=w.history.loss[0];"number"==typeof e&&(b=e)}else if("number"==typeof w.history.loss)b=w.history.loss;else if(w.history.loss&&"object"==typeof w.history.loss)try{let e=JSON.stringify(w.history.loss);JSON.parse(e)}catch{}return this.epsilon=Math.max(this.config.epsilonEnd,this.epsilon*this.config.epsilonDecay),this.stepCount++,this.stepCount%this.config.targetUpdateFrequency==0&&this.updateTargetNetwork(),b}catch(e){return!(h(e)?e.message:String(e)).includes("disposed"),0}finally{g.forEach(e=>{try{e.dispose()}catch(e){}})}}updateTargetNetwork(){if(!this.qNetwork||!this.targetNetwork)return;let e=this.qNetwork.getWeights();this.targetNetwork.setWeights(e)}getEpsilon(){return this.epsilon}async save(t){if(!this.qNetwork)throw Error("Network not initialized. Cannot save model.");if(!this.areNetworksValid())throw Error("Network has been disposed. Cannot save model.");if("undefined"==typeof indexedDB)throw Error("IndexedDB is not available in this browser. Cannot save model.");try{if(!t.startsWith("indexeddb://"))throw Error(`Invalid path format. Expected 'indexeddb://...', got: ${t}`);let a=t.replace("indexeddb://","");if(a.includes("/")||a.includes("\\")||a.includes(" "))throw Error(`Invalid model name. Object store names cannot contain slashes or spaces. Got: ${a}`);if(0===a.length)throw Error("Invalid model name. Model name cannot be empty.");if("undefined"==typeof indexedDB)throw Error("IndexedDB is not available in this browser. Cannot save model.");try{let e="__tfjs_test_db__",t=indexedDB.open(e);await new Promise((a,i)=>{t.onsuccess=()=>{t.result.close(),indexedDB.deleteDatabase(e),a()},t.onerror=()=>i(Error("IndexedDB open failed - may be restricted")),t.onblocked=()=>i(Error("IndexedDB is blocked - may need user interaction"))})}catch(t){let e=t instanceof Error?t:Error(String(t));throw console.warn("DQNAgent: IndexedDB access test failed:",e.message),Error(`IndexedDB access restricted: ${e.message}. This may be due to browser privacy settings, private browsing mode, or iframe permissions.`)}let i=null;try{if(this.qNetwork.getWeights(),!this.qNetwork.optimizer)throw Error("Model is not compiled. Cannot save uncompiled model.");0===this.stepCount&&console.warn("DQNAgent: WARNING - Model has not been trained yet (stepCount = 0). Saving anyway, but this may cause issues.");try{i=await this.qNetwork.save(t)}catch(a){let e=a instanceof Error?a:Error(String(a));throw console.error("DQNAgent: TensorFlow.js save() threw an error:",e),console.error("DQNAgent: Error details:",{message:e.message,stack:e.stack,path:t,modelCompiled:!!this.qNetwork.optimizer}),Error(`TensorFlow.js save() failed: ${e.message}`)}if(await new Promise(e=>setTimeout(e,200)),indexedDB.databases)try{let e=(await indexedDB.databases()).find(e=>"tensorflowjs_models"===e.name||e.name&&e.name.includes("tensorflow"));if(e&&e.name){let t=indexedDB.open(e.name);t.onsuccess=()=>{t.result.close()},t.onerror=()=>{console.warn("DQNAgent: Could not inspect TensorFlow.js database")}}else console.warn("DQNAgent: WARNING - No TensorFlow.js database found after save!")}catch(e){console.warn("DQNAgent: Could not list databases:",e)}try{let e=await eX.io.listModels(),a=Object.keys(e),i=t.replace("indexeddb://","");a.some(e=>e.includes(i)||e===t||e.endsWith(i))||(console.warn("DQNAgent: WARNING - Model not found in TensorFlow.js list, but save() completed"),console.warn("DQNAgent: Expected path:",t),console.warn("DQNAgent: Clean path:",i))}catch(e){console.warn("DQNAgent: Could not list models (this is okay):",e)}try{(await eQ.loadLayersModel(t)).dispose()}catch(t){let e=t instanceof Error?t:Error(String(t));console.error("DQNAgent: CRITICAL - Model save() completed but cannot be loaded!"),console.error("DQNAgent: Load error:",e.message),console.error("DQNAgent: Load error stack:",e.stack);try{let e=await eX.io.listModels();console.error("DQNAgent: Available models according to TensorFlow.js:",Object.keys(e))}catch(e){console.error("DQNAgent: Could not list models:",e)}throw Error(`Model save() completed but verification load failed: ${e.message}. This indicates the model was not actually saved to IndexedDB.`)}if(i||console.warn("DQNAgent: WARNING - save() returned null/undefined"),"function"==typeof indexedDB.databases){let{debugListAllIndexedDBDatabases:t}=await e.A(5808);await t()}}catch(t){let e=t instanceof Error?t:Error(String(t));throw console.error("DQNAgent: Error during model.save():",e),console.error("DQNAgent: Error message:",e.message),console.error("DQNAgent: Error stack:",e.stack),e}await new Promise(e=>setTimeout(e,500));let{modelExists:s,listAvailableModelPaths:r}=await e.A(5808);await r();let n=!1,o=0;for(;!n&&o<5;)(n=await s(t))||!(o<4)||(await r(),await new Promise(e=>setTimeout(e,500))),o++;if(!n){let e=await r(),i=`Model save() completed but weights were NOT saved to IndexedDB.
Expected path: ${t}
Clean path: ${a}
Available paths: ${e.join(", ")||"none"}
This suggests TensorFlow.js save() failed silently or used a different path format.`;throw console.error("DQNAgent: CRITICAL ERROR:",i),Error(i)}}catch(e){throw console.error("DQNAgent: Error saving model:",e),e}}async load(t){this.trainingInProgress&&await this.trainingInProgress.catch(()=>{});let{modelExists:a,listAvailableModelPaths:i,listSavedModels:s}=await e.A(5808);if(!await a(t)){let e=(await s()).find(e=>e.path===t),a=await i(),r=t.replace("indexeddb://",""),n=`Cannot find model weights for '${t}'.

`;throw n+=`Note: Model metadata is stored in Dexie DB, but the actual model weights are stored in TensorFlow.js IndexedDB.

`,e&&(n+=`⚠️ Model metadata exists in Dexie, but the model weights are missing from TensorFlow.js IndexedDB.
This can happen if:
• The model was deleted from IndexedDB but metadata remains
• Browser storage was cleared for IndexedDB but not Dexie
• There was an error during model save

`),n+=`Looking for TensorFlow.js object store: '${r}'

`,a.length>0?(n+=`Available models in TensorFlow.js IndexedDB:
`,a.forEach(e=>{n+=`  - ${e}
`})):n+="No models found in TensorFlow.js IndexedDB. Make sure you've saved a model first.",Error(n)}try{let e=await eQ.loadLayersModel(t);e.compile({optimizer:eY.train.adam(this.config.learningRate),loss:"meanSquaredError"});let a=this.createNetwork();this.qNetwork&&this.qNetwork.dispose(),this.targetNetwork&&this.targetNetwork.dispose(),this.qNetwork=e,this.targetNetwork=a,this.updateTargetNetwork()}catch(s){console.error("DQNAgent: Error loading model:",s);let e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),a=s instanceof Error?s.message:String(s),i=`Failed to load model from ${t}: ${a}`;throw e&&(i+='\n\nSafari detected. Common issues:\n• Private Browsing mode disables IndexedDB - try regular browsing mode\n• Safari may require user interaction before accessing IndexedDB\n• Check Safari settings: Preferences > Privacy > uncheck "Prevent cross-site tracking"'),Error(i)}}async loadWeightsFromJSON(e){if(this.trainingInProgress&&await this.trainingInProgress.catch(()=>{}),this.qNetwork&&this.targetNetwork||await this.initialize(),!this.qNetwork||!this.targetNetwork)throw Error("Failed to initialize networks");try{let t=[];for(let a of e){let e=t.length/2,i=this.qNetwork.layers[e];if(!i)throw Error(`Layer ${e} not found in network`);let s=i.getWeights()[0].shape;i.getWeights()[1].shape;let r=eJ.tensor2d(a.weights,s),n=eK.tensor1d(a.biases);t.push(r,n)}this.qNetwork.setWeights(t),this.targetNetwork.setWeights(t),this.updateTargetNetwork(),t.forEach(e=>e.dispose())}catch(e){throw console.error("DQNAgent: Error loading weights from JSON:",e),Error(`Failed to load weights from JSON: ${e instanceof Error?e.message:String(e)}`)}}dispose(){this.isDisposed=!0;let e=()=>{this.qNetwork&&this.qNetwork.dispose(),this.targetNetwork&&this.targetNetwork.dispose()};this.trainingInProgress?this.trainingInProgress.then(e).catch(e):e()}}class e1{buffer=[];maxSize;currentIndex=0;constructor(e=1e4){this.maxSize=e}add(e){this.buffer.length<this.maxSize?this.buffer.push(e):(this.buffer[this.currentIndex]=e,this.currentIndex=(this.currentIndex+1)%this.maxSize)}addBatch(e){for(let t of e)this.add(t)}sample(e){if(this.buffer.length<e)return[...this.buffer];let t=[],a=[];for(;t.length<e;){let e=Math.floor(Math.random()*this.buffer.length);t.includes(e)||(t.push(e),a.push(this.buffer[e]))}return a}size(){return this.buffer.length}canSample(e){return this.buffer.length>=e}clear(){this.buffer=[],this.currentIndex=0}getAll(){return[...this.buffer]}}var e2=e.i(43073);class e5{agent;replayBuffer;env;config;stats;isTraining=!1;currentEpisode=0;completedEpisodes=0;stepCount=0;hasTrainedAtLeastOnce=!1;gameStates=new Map;activeGameEpisodes=new Set;gameEpisodeRewards=new Map;gameEpisodeLengths=new Map;constructor(e={}){this.config={dqn:{},episodes:1e3,trainEvery:4,saveEvery:100,selfPlay:!0,headless:!1,maxEpisodeTimeMs:6e4,...e},this.agent=new e0({...eZ,...this.config.dqn}),this.replayBuffer=new e1(this.config.dqn.replayBufferSize||eZ.replayBufferSize),this.env=new eW(this.config.maxEpisodeTimeMs),this.stats={episode:0,episodeReward:0,episodeLength:0,totalReward:0,averageReward:0,epsilon:1,loss:0}}async initialize(){await this.agent.initialize();let e=new eL({name:"TankTroubleRL",type:"discrete",observationSize:eZ.observationSize,actionSize:eZ.actionSize}),t={isLoaded:()=>e.isLoaded(),load:t=>e.load(t),getInfo:()=>e.getInfo(),agent:this.agent,predict:(e,t)=>({angleDelta:0,moveDirection:0,shouldShoot:!1})};eC.setModel(t)}async step(e,t,a,i){if(!this.isTraining)return;this.env.getObservation(e);let s=i||"default",r=this.gameStates.get(s);if(!r||!r.observation){r=this.env.reset(e),this.gameStates.set(s,r),this.activeGameEpisodes.add(s),this.gameEpisodeRewards.set(s,0),this.gameEpisodeLengths.set(s,0),this.updateSharedStats();return}let n=0;n=null!=a?a:await this.agent.selectAction(r.observation,!0);let o=this.env.step(n,e,t);if(!r||!r.observation||!o||!o.observation)return void this.gameStates.set(s,o||this.env.reset(e));let l={state:r.observation.vector,action:n,reward:o.reward,nextState:o.observation.vector,done:o.done};this.replayBuffer.add(l);let d=this.gameEpisodeRewards.get(s)||0,c=this.gameEpisodeLengths.get(s)||0;if(this.gameEpisodeRewards.set(s,d+o.reward),this.gameEpisodeLengths.set(s,c+1),this.updateSharedStats(),this.stats.episodeLength,this.stepCount++,this.stepCount%this.config.trainEvery==0&&this.replayBuffer.canSample(32)){let e=this.replayBuffer.sample(32),t=await this.agent.train(e);this.stats.loss=t,this.hasTrainedAtLeastOnce=!0,this.config.onTrainingUpdate&&this.config.onTrainingUpdate({loss:t,epsilon:this.agent.getEpsilon()})}o.done?(await this.onEpisodeComplete(o,s),this.gameStates.delete(s)):this.gameStates.set(s,o)}updateSharedStats(){let e=0,t=0;for(let[t,a]of this.gameEpisodeRewards.entries())this.activeGameEpisodes.has(t)&&(e+=a);for(let[e,a]of this.gameEpisodeLengths.entries())this.activeGameEpisodes.has(e)&&(t+=a);this.stats.episodeReward=e,this.stats.episodeLength=t}incrementEpisode(){if(this.currentEpisode++,this.stats.episode=this.currentEpisode,this.stats.epsilon=this.agent.getEpsilon(),this.completedEpisodes>0&&(this.stats.averageReward=this.stats.totalReward/this.completedEpisodes),this.currentEpisode%this.config.saveEvery==0){let e=Date.now(),t=new Date(e).toISOString(),a=this.stats.averageReward;this.saveModel(`indexeddb://tank-ai-${e}`,a,t).catch(e=>{console.error("Error saving model:",e)})}this.config.onEpisodeComplete&&this.config.onEpisodeComplete({...this.stats})}async onEpisodeComplete(e,t){let a=t.includes("-blue"),i=a?t.replace("-blue",""):t,s=this.gameEpisodeRewards.get(i)||0,r=this.gameEpisodeRewards.get(`${i}-blue`)||0;this.gameEpisodeLengths.get(i),this.gameEpisodeLengths.get(`${i}-blue`),!a&&(this.stats.totalReward+=s+r,this.completedEpisodes++,this.completedEpisodes>0&&(this.stats.averageReward=this.stats.totalReward/this.completedEpisodes)),this.activeGameEpisodes.delete(i),this.activeGameEpisodes.delete(`${i}-blue`),this.updateSharedStats()}start(){this.isTraining||(this.isTraining=!0,this.currentEpisode=0,this.completedEpisodes=0,this.stepCount=0,this.stats.episodeReward=0,this.stats.episodeLength=0,this.stats.totalReward=0,this.stats.averageReward=0,this.activeGameEpisodes.clear(),this.gameEpisodeRewards.clear(),this.gameEpisodeLengths.clear())}stop(){this.isTraining=!1}getIsTraining(){return this.isTraining}getStats(){return{...this.stats}}canSaveModel(){let e=this.replayBuffer.canSample(32),t=this.currentEpisode>0;return e&&t&&this.hasTrainedAtLeastOnce}getReplayBufferSize(){return this.replayBuffer.size()}async saveModel(e,t,a){let i=e.startsWith("indexeddb://")?e:`indexeddb://${e}`;if(!this.agent)throw Error("Agent not initialized. Cannot save model.");try{await this.agent.save(i)}catch(e){throw console.error("RLTrainingManager: Model weights save/verification failed:",e),Error(`Failed to save model weights: ${e instanceof Error?e.message:String(e)}`)}try{await (0,e2.saveModelWithMetadata)(i,t,a)}catch(e){console.warn("RLTrainingManager: Failed to save model metadata (weights are saved):",e)}}async loadModel(e){await this.agent.load(`indexeddb://${e}`)}resetEpisode(e,t){let a=this.env.reset(e);this.gameStates.set(t||"default",a)}getMaxEpisodeTimeMs(){return this.config.maxEpisodeTimeMs}dispose(){this.stop(),this.agent.dispose(),this.replayBuffer.clear()}}function e3({stats:e,onUpdate:t}){let a=(0,s.useRef)(null);return(0,s.useEffect)(()=>{let i=a.current;i&&i.episodeReward===e.episodeReward&&i.episodeLength===e.episodeLength||(a.current=e,t(e))},[e.episodeReward,e.episodeLength,t]),null}let e6={width:(t=g(r.default,function(e){return!!o(e)&&u(e,"width",l)&&u(e,"height",l)&&u(e,"barriers",e=>d(e))&&u(e,"spawnPoints",e=>d(e))&&(!("suns"in e)||u(e,"suns",e=>d(e)))},"Invalid map data structure: missing or invalid required properties")).width,height:t.height,barriers:t.barriers,spawnPoints:t.spawnPoints,suns:t.suns||[]};function e4(){let e=e6.barriers||[],t=[],[a,r]=(0,s.useState)(!1),[n,o]=(0,s.useState)(0),l=(0,s.useRef)(null),[d,c]=(0,s.useState)({totalGames:0,aiVsAiGames:0,personVsAiGames:0}),[u,g]=(0,s.useState)(4),[m,x]=(0,s.useState)([]),[y,v]=(0,s.useState)(""),[w,b]=(0,s.useState)(!1),T=(0,s.useRef)(""),[k,S]=(0,s.useState)(null),N=(0,s.useCallback)(e=>{S(t=>t&&t.reward===e.episodeReward&&t.length===e.episodeLength?t:{reward:e.episodeReward,length:e.episodeLength})},[]),[M,j]=(0,s.useState)(null),E=(0,s.useRef)(5),[A,P]=(0,s.useState)(Date.now());(0,s.useEffect)(()=>{let e=setInterval(()=>{P(Date.now())},1e3);return()=>clearInterval(e)},[]);let[D,R]=(0,s.useState)(()=>Array.from({length:4},(a,i)=>({id:i,tanks:ek(e6,e,t),bullets:[],lastShotTimes:{blue:0,red:0},gameOverWinner:null,episodeReward:0,episodeLength:0,episodeStartTime:Date.now(),gameType:"ai-vs-ai",episodeNumber:i+1}))),I=function(e={}){let[t,a]=(0,s.useState)(!1),[i,r]=(0,s.useState)(null),[n,o]=(0,s.useState)(!1),l=(0,s.useRef)(null),d=(0,s.useRef)(e);(0,s.useEffect)(()=>{d.current=e},[e]);let c=(0,s.useRef)(e.onEpisodeComplete),h=(0,s.useRef)(e.onTrainingUpdate);(0,s.useEffect)(()=>{c.current=e.onEpisodeComplete,h.current=e.onTrainingUpdate},[e.onEpisodeComplete,e.onTrainingUpdate]),(0,s.useEffect)(()=>{let e=new e5({...d.current,onEpisodeComplete:e=>{r(t=>{let a=(t?.loss??0)>0?t?.loss??0:e.loss;return{...e,loss:a}}),c.current&&c.current(e)},onTrainingUpdate:e=>{r(t=>{let a=e=>"string"==typeof e&&["episode","episodeReward","episodeLength","totalReward","averageReward","epsilon","loss"].includes(e),i={};for(let[t,s]of Object.entries(e))void 0!==s&&a(t)&&(i[t]=s);return t?Object.keys(i).some(e=>!!a(e)&&t[e]!==i[e])?{...t,...i}:t:{episode:0,episodeReward:0,episodeLength:0,totalReward:0,averageReward:0,epsilon:1,loss:0,...i}}),h.current&&h.current(e)}});return e.initialize().then(()=>{o(!0),l.current=e,r(e.getStats())}),()=>{l.current&&l.current.dispose()}},[]);let u=async(e,a,i)=>{l.current&&t&&await l.current.step(e,a,i)};return{isTraining:t,isInitialized:n,stats:i,startTraining:()=>{l.current&&n&&(l.current.start(),a(!0))},stopTraining:()=>{l.current&&(l.current.stop(),a(!1))},step:u,saveModel:async(e,t,a)=>{l.current&&await l.current.saveModel(e,t,a)},loadModel:async e=>{l.current&&await l.current.loadModel(e)},resetEpisode:e=>{l.current&&l.current.resetEpisode(e)},incrementEpisode:()=>{l.current&&l.current.incrementEpisode()},canSaveModel:()=>!!l.current&&l.current.canSaveModel(),getReplayBufferSize:()=>l.current?l.current.getReplayBufferSize():0,get manager(){return l.current}}}({episodes:1e3,trainEvery:4,saveEvery:100,selfPlay:!0}),L=D.length;(0,s.useEffect)(()=>{if(I.stats&&void 0!==I.stats.episode){let e=I.stats.episode;c(t=>({...t,totalGames:e}))}},[I.stats?.episode]),(0,s.useEffect)(()=>{I.stats&&void 0!==I.stats.episode&&g(I.stats.episode+L)},[I.stats?.episode,L]);let C=(0,s.useCallback)(async()=>{if(!I.manager||!I.canSaveModel())return!1;try{I.stats?.episode;let e=Date.now();return new Date(e).toISOString(),I.stats?.averageReward,!0}catch(e){return console.error("Error auto-saving model:",e),!1}},[I,L]);(0,s.useEffect)(()=>{if(a&&I.isTraining)return l.current&&clearInterval(l.current),l.current=setInterval(()=>{C()},3e5),()=>{l.current&&clearInterval(l.current)};l.current&&(clearInterval(l.current),l.current=null)},[a,I.isTraining,C]),(0,s.useEffect)(()=>{let i=a?8:4;R(a=>{if(a.length===i)return a;if(a.length<i){let s=Array.from({length:i-a.length},(i,s)=>({id:a.length+s,tanks:ek(e6,e,t),bullets:[],lastShotTimes:{blue:0,red:0},gameOverWinner:null,episodeReward:0,episodeLength:0,episodeStartTime:Date.now(),gameType:"ai-vs-ai",episodeNumber:E.current++}));return[...a,...s]}{let e=a.slice(0,i);if(-1===(null!==M?e.findIndex(e=>e.id===M):-1)&&null!==M){let e=a.find(e=>e.id===M);if(e)return[...a.filter(e=>e.id!==M).slice(0,i-1),e]}return e}})},[a,e6,e,t,M]);let B=f(),F=p({gameOver:null!==M&&D[M]?.gameOverWinner!==null}),z=(0,s.useRef)(new Set),$=(0,s.useCallback)(e=>e===M?F.keysRef:z,[M,F.keysRef]),q=e=>{M===e&&j(null),R(t=>t.map(t=>t.id===e?{...t,gameType:"ai-vs-ai"}:t))},W=I.manager?.getMaxEpisodeTimeMs()||6e4,O=(0,s.useMemo)(()=>D.map(e=>({id:e.id,tanks:e.tanks,bullets:e.bullets,lastShotTimes:e.lastShotTimes,gameMode:"person-vs-ai"===e.gameType?"person-vs-ai":"ai",gameId:`game-${e.id}`,isPaused:!I.isTraining||e.id===M&&F.isPaused,speedMultiplier:(e.gameType,1),episodeStartTime:e.episodeStartTime,keysRef:$(e.id)})),[D,I.isTraining,M,F.isPaused,$]),G=eG({mapData:e6,barriers:e,suns:t,aiConfig:eF,trainingManager:I.manager,maxEpisodeTimeMs:W,gameInstances:O,onTanksUpdate:(e,t)=>{R(a=>a.map(a=>a.id===e?{...a,tanks:t}:a))},onBulletsUpdate:(e,t)=>{R(a=>a.map(a=>a.id===e?{...a,bullets:t}:a))},onLastShotTimesUpdate:(e,t)=>{R(a=>a.map(a=>a.id===e?{...a,lastShotTimes:t}:a))},onGameOver:(a,i)=>{let s=E.current++;I.incrementEpisode();let r=D.find(e=>e.id===a),n=r?.gameType==="person-vs-ai";R(i=>i.map(i=>i.id===a?(c(e=>({...e,aiVsAiGames:"ai-vs-ai"===i.gameType?e.aiVsAiGames+1:e.aiVsAiGames,personVsAiGames:"person-vs-ai"===i.gameType?e.personVsAiGames+1:e.personVsAiGames})),{...i,tanks:ek(e6,e,t),bullets:[],lastShotTimes:{blue:0,red:0},gameOverWinner:null,episodeReward:0,episodeLength:0,episodeStartTime:Date.now(),episodeNumber:s}):i)),a!==M||n||j(null)}});(0,s.useEffect)(()=>{if(!I.isTraining)return;let e=[],t=performance.now(),a=async i=>{for(let e of D){"ai-vs-ai"===e.gameType&&!1;await G.gameTick({gameId:e.id});if(e.episodeStartTime){let t=Math.floor(72*((Date.now()-e.episodeStartTime)/1e3));e.episodeLength!==t&&R(a=>a.map(a=>a.id===e.id?{...a,episodeLength:t}:a))}}t=i;let s=requestAnimationFrame(a);e.push(s)},i=requestAnimationFrame(a);return e.push(i),()=>{e.forEach(e=>cancelAnimationFrame(e))}},[I.isTraining,G,D]);let U=(0,s.useCallback)(async()=>{b(!0);try{let e=await (0,e2.listSavedModels)();x(e),T.current&&e.some(e=>e.path===T.current)}catch(e){console.error("Failed to load models:",e),/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&void 0===window.indexedDB&&console.warn("Safari detected with IndexedDB unavailable. This may be due to Private Browsing mode.")}finally{b(!1)}},[]);(0,s.useEffect)(()=>{U()},[U]),(0,s.useEffect)(()=>{if(I.stats&&I.stats.episode>0&&I.stats.episode%100==0){let e=T.current;U().then(()=>{e&&(v(e),T.current=e)})}},[I.stats?.episode,U]);let H=async e=>{if(e)try{v(e),T.current=e;let t=new e0;await t.load(e);let a=new eL({name:"TankTroubleRL",type:"discrete",observationSize:142,actionSize:14});if(eC.setModel({isLoaded:()=>a.isLoaded(),load:e=>a.load(e),getInfo:()=>a.getInfo(),agent:t,predict:(e,t)=>({angleDelta:0,moveDirection:0,shouldShoot:!1})}),I.manager){let t=e.replace("indexeddb://","");await I.manager.loadModel(t)}alert("Model loaded successfully! Training will continue from this model.")}catch(i){console.error("Failed to load model:",i);let e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),t=i instanceof Error?i.message:String(i),a="Failed to load model.\n\n";e&&(a+='Safari detected. Common issues:\n• Private Browsing mode disables IndexedDB - try regular browsing mode\n• Safari may require user interaction before accessing IndexedDB\n• Check Safari settings: Preferences > Privacy > uncheck "Prevent cross-site tracking"\n\n'),alert(a+=`Error: ${t}

Check the browser console for more details.`)}},V=Math.ceil(Math.sqrt(4)),Q=eC.getModel().getInfo(),Y=eC.isRLActive();return(0,i.jsxs)("div",{className:"flex flex-col gap-4 w-full",children:[(0,i.jsx)("div",{className:"flex gap-4",children:(0,i.jsxs)("div",{className:"flex-1 space-y-4",children:[(0,i.jsxs)("div",{className:"p-4 bg-white border border-gray-300 rounded shadow",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("label",{className:"text-sm font-semibold whitespace-nowrap",children:"Select Model (Optional):"}),(0,i.jsxs)("select",{value:y,onChange:e=>H(e.target.value),className:"px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",style:{maxWidth:"200px"},disabled:w,children:[(0,i.jsx)("option",{value:"",children:w?"Loading models...":"-- Select a model --"}),0===m.length&&!w&&(0,i.jsx)("option",{value:"",disabled:!0,children:"No saved models found"}),m.map(e=>(0,i.jsxs)("option",{value:e.path,children:[e.createdAtString,void 0!==e.evalScore?` (Eval: ${e.evalScore.toFixed(2)})`:""]},e.path))]}),(0,i.jsx)("button",{onClick:U,style:{backgroundColor:"#e5e7eb"},className:"px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:bg-gray-200 disabled:opacity-50 text-sm font-medium whitespace-nowrap flex-shrink-0",disabled:w,children:w?"Loading...":"Refresh"}),(0,i.jsx)("button",{onClick:async()=>{try{b(!0);let e=await fetch("/api/backend/models/latest");if(!e.ok)throw Error(`Failed to fetch model: ${e.statusText}`);await e.json(),new e0,alert("Model fetched from backend! (Conversion to TensorFlow.js format pending)")}catch(e){console.error("Error fetching model from backend:",e),alert(`Failed to fetch model from backend: ${e instanceof Error?e.message:String(e)}`)}finally{b(!1)}},style:{backgroundColor:"#dbeafe"},className:"px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 disabled:bg-gray-200 disabled:opacity-50 text-sm font-medium whitespace-nowrap flex-shrink-0",disabled:w,children:w?"Loading...":"Fetch from Backend"})]}),(0,i.jsx)("div",{className:"mt-2 text-xs text-gray-500 italic",children:"Models are saved in your browser's local storage (Dexie DB). Maximum 8 models kept."})]}),(0,i.jsxs)("div",{className:"p-4 bg-white border border-gray-300 rounded shadow",children:[(0,i.jsxs)("div",{className:"flex items-center gap-4 flex-wrap",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,i.jsx)("button",{onClick:async()=>{try{if(!I.manager)return void alert("Training manager not initialized. Please wait for initialization.");if(!I.canSaveModel()){let e=I.getReplayBufferSize(),t=(I.stats?.episode??0)>0,a="Cannot save model yet. Requirements:\n";e<32&&(a+=`- Need at least 32 steps in replay buffer (current: ${e})
`),t||(a+="- Need at least one completed episode\n"),e>=32&&t&&(a+="- Need to wait for training to occur (training happens every 4 steps when buffer has 32+ steps)\n"),alert(a);return}I.stats?.episode;let e=Date.now();new Date(e).toISOString(),I.stats?.averageReward,alert("Frontend training is disabled. Models are saved automatically by the backend training service every 5 minutes.")}catch(t){console.error("Error saving model:",t);let e=h(t)?t.message:String(t);alert(`Failed to save model: ${e}

Check the browser console for details.`)}},disabled:!I.manager||!I.canSaveModel(),style:{backgroundColor:I.manager&&I.canSaveModel()?"#bfdbfe":"#d1d5db",opacity:I.manager&&I.canSaveModel()?1:.6,cursor:I.manager&&I.canSaveModel()?"pointer":"not-allowed"},className:`px-4 py-2 rounded font-medium ${!I.manager||!I.canSaveModel()?"bg-gray-300 text-gray-500":"bg-blue-200 text-blue-700 hover:bg-blue-300"}`,title:I.manager&&I.canSaveModel()?"Save current model (creates new model, does not overwrite)":"Requirements: 32+ steps in replay buffer, at least 1 episode completed, and training must have occurred at least once",children:"Save Model"}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("input",{type:"checkbox",id:"headless-mode",checked:a,onChange:e=>r(e.target.checked),className:"w-4 h-4"}),(0,i.jsx)("label",{htmlFor:"headless-mode",className:"text-sm font-medium cursor-pointer",children:"Headless Training (8 games, auto-save every 5 min)"}),a&&n>0&&(0,i.jsxs)("span",{className:"text-xs text-gray-600",children:["(Auto-saved: ",n,")"]})]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,i.jsx)("span",{className:`inline-block w-3 h-3 rounded-full ${I.isTraining?"bg-green-500":"bg-gray-400"}`}),(0,i.jsx)("span",{children:I.isTraining?"Training Active":"Training Stopped"})]})]}),(0,i.jsx)("div",{className:"mt-2 text-xs text-gray-500 italic",children:"Saving a model requires: 32+ steps in replay buffer, at least 1 episode completed, and training must have occurred at least once"})]}),(0,i.jsx)("div",{className:"p-4 bg-white border border-gray-300 rounded shadow",children:(0,i.jsxs)("div",{className:"grid gap-4",style:{gridTemplateColumns:`repeat(${Math.min(L,8)}, 1fr)`},children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-gray-600",children:"Total Games"}),(0,i.jsx)("div",{className:"text-2xl font-bold",children:I.stats?.episode||0})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-gray-600",children:"AI vs AI"}),(0,i.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:d.aiVsAiGames})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-gray-600",children:"Person vs AI"}),(0,i.jsx)("div",{className:"text-2xl font-bold text-green-600",children:d.personVsAiGames})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"text-sm text-gray-600",children:"Active Games"}),(0,i.jsx)("div",{className:"text-2xl font-bold text-purple-600",children:L})]})]})}),(0,i.jsxs)("div",{className:"p-4 bg-white border border-gray-300 rounded shadow",children:[(0,i.jsx)("h3",{className:"font-semibold mb-2",children:"Model Summary"}),(0,i.jsxs)("div",{className:"grid grid-cols-3 gap-4 text-sm mb-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Model Type: "}),(0,i.jsx)("span",{className:"font-semibold",children:Y?"RL (Trained)":"Rule-Based (Fallback)"})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:"Type of AI model being used"})]}),(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Action Space: "}),(0,i.jsx)("span",{className:"font-semibold",children:"discrete"===Q.type?"Discrete (14 actions)":"Continuous"})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:"Number of possible actions the AI can take"})]}),(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Observation Size: "}),(0,i.jsxs)("span",{className:"font-semibold",children:[Q.observationSize," features"]})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:"Number of input features the AI observes"})]})]}),I.stats&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e3,{stats:I.stats,onUpdate:N}),(0,i.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-200",children:[(0,i.jsx)("h4",{className:"font-semibold mb-2 text-sm",children:"Training Statistics"}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-3 text-sm mb-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Games: "}),(0,i.jsx)("span",{className:"font-semibold",children:I.stats.episode})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:"Total games completed (auto-saves every 100 games). Each game = one complete game session."})]}),(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Avg Reward: "}),(0,i.jsx)("span",{className:"font-semibold",children:(I.stats.averageReward??0).toFixed(2)})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:"Average reward per game"})]}),(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Epsilon: "}),(0,i.jsx)("span",{className:"font-semibold",children:(I.stats.epsilon??0).toFixed(3)})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:"Exploration rate (higher = more random)"})]})]}),(0,i.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-200",children:[(0,i.jsx)("h4",{className:"font-semibold mb-2 text-sm",children:"Active Games Stats"}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Reward: "}),(0,i.jsx)("span",{className:"font-semibold",children:k?.reward!==void 0?k.reward.toFixed(2):I.stats?.episodeReward.toFixed(2)||"0.00"})]}),(0,i.jsxs)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:["Total reward across all ",L," active games (positive = good, negative = poor performance, but still valid training data)"]})]}),(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Length: "}),(0,i.jsx)("span",{className:"font-semibold",children:k?.length!==void 0?k.length:I.stats?.episodeLength||0})]}),(0,i.jsxs)("div",{className:"text-xs text-gray-500 italic mt-0.5",children:["Total steps across all ",L," active games (updates every 5 seconds)"]})]})]})]})]})]})]})]})}),(0,i.jsx)("div",{className:"w-full",children:(0,i.jsxs)("div",{className:"p-4 bg-white border border-gray-300 rounded shadow",children:[(0,i.jsx)("h3",{className:"font-semibold mb-3 text-lg",children:"Game Status"}),(0,i.jsx)("div",{className:"grid gap-4",style:{gridTemplateColumns:"repeat(4, 1fr)"},children:D.map(e=>{var t;let a,s=e.tanks[0]?.lives||0,r=e.tanks[1]?.lives||0;e.gameType;let n="person-vs-ai"===e.gameType,o=I.isTraining&&e.episodeStartTime,l=0;return o&&(l=Math.floor((A-e.episodeStartTime)/1e3)),(0,i.jsxs)("div",{className:"border border-gray-200 rounded p-3",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,i.jsxs)("div",{className:"font-semibold text-sm",children:["Game ",e.id+1]}),(0,i.jsx)("div",{className:`text-xs px-2 py-1 rounded ${n?"bg-green-100 text-green-700":"bg-blue-100 text-blue-700"}`,children:n?"Person vs AI":"AI vs AI"})]}),(0,i.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,i.jsxs)("div",{className:"flex justify-between",children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Status:"}),(0,i.jsx)("span",{className:`font-semibold ${I.isTraining?"text-green-600":"text-gray-400"}`,children:I.isTraining?"Active":"Paused"})]}),(0,i.jsxs)("div",{className:"flex justify-between",children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Duration:"}),(0,i.jsx)("span",{className:"font-mono font-semibold text-gray-700",children:o?(a=Math.floor((t=l)/60),`${a}:${(t%60).toString().padStart(2,"0")}`):"N/A"})]}),(0,i.jsxs)("div",{className:"flex justify-between",children:[(0,i.jsx)("span",{className:"text-blue-600",children:"Blue Lives:"}),(0,i.jsx)("span",{className:"font-mono font-semibold",children:s})]}),(0,i.jsxs)("div",{className:"flex justify-between",children:[(0,i.jsx)("span",{className:"text-red-600",children:"Red Lives:"}),(0,i.jsx)("span",{className:"font-mono font-semibold",children:r})]}),I.stats&&(0,i.jsxs)("div",{className:"flex justify-between",children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Model:"}),(0,i.jsxs)("span",{className:"font-semibold text-blue-600",children:["v",Math.floor((I.stats.episode||0)/4)+1]})]}),e.gameOverWinner&&(0,i.jsxs)("div",{className:"mt-1 pt-1 border-t border-gray-200",children:[(0,i.jsx)("span",{className:"text-gray-600",children:"Winner: "}),(0,i.jsx)("span",{className:`font-semibold ${"blue"===e.gameOverWinner?"text-blue-600":"text-red-600"}`,children:e.gameOverWinner.toUpperCase()})]})]})]},e.id)})})]})}),!a&&(0,i.jsx)("div",{className:"w-full",children:(0,i.jsx)("div",{className:"grid gap-4",style:{gridTemplateColumns:`repeat(${V}, 1fr)`},children:D.map(a=>{$(a.id);let s="person-vs-ai"===a.gameType,r=2*e6.width*.45,n=2*e6.height*.45,o=M===a.id;return(0,i.jsxs)("div",{className:`border rounded p-2 bg-gray-50 relative flex flex-col items-center ${o?"border-blue-600 border-2":"border-gray-300"}`,style:{height:`${n+60}px`,minHeight:`${n+60}px`,maxHeight:`${n+60}px`,overflow:"hidden"},children:[(0,i.jsxs)("div",{className:"flex items-center justify-between mb-1 w-full",style:{width:`${r}px`},children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsxs)("span",{className:"text-xs font-bold text-gray-700",children:["ID: ",a.id+1]}),(0,i.jsxs)("span",{className:"text-xs px-2 py-0.5 bg-gray-100 text-gray-700 rounded font-medium",children:["Game ",a.episodeNumber," / ",(I.stats?.episode||0)+4]})]}),!s&&(0,i.jsx)("div",{className:"relative",children:(0,i.jsx)("button",{onClick:()=>{var e;(null===M||M===a.id)&&(e=a.id,null!==M&&M!==e&&q(M),j(e),R(t=>t.map(t=>t.id===e?{...t,gameType:"person-vs-ai"}:t)))},className:`text-xs px-2 py-1 rounded font-medium transition-colors ${!I.isTraining||null!==M&&M!==a.id?"bg-gray-300 text-gray-500 cursor-not-allowed opacity-60":"bg-green-100 text-green-700 hover:bg-green-200 cursor-pointer"}`,disabled:!I.isTraining||null!==M&&M!==a.id,children:M===a.id?"You are playing":"Join Game"})}),s&&(0,i.jsx)("button",{onClick:()=>q(a.id),className:"text-xs px-2 py-1 bg-orange-200 text-orange-700 rounded hover:bg-orange-300 font-medium",children:"Make AI vs AI"})]}),!I.isTraining&&(0,i.jsx)("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10 rounded",children:(0,i.jsx)("div",{className:"text-white text-sm",children:"Training paused"})}),(0,i.jsx)("div",{className:"flex justify-center items-center overflow-hidden",style:{width:`${r}px`,height:`${n}px`},children:(0,i.jsx)(eU,{width:e6.width,height:e6.height,tanks:a.tanks,bullets:a.bullets,barriers:e,suns:t,isPaused:!I.isTraining,tankImages:B,gameOverWinner:a.gameOverWinner,scale:.45})})]},a.id)})})}),a&&(0,i.jsxs)("div",{className:"w-full p-8 bg-gray-100 border border-gray-300 rounded text-center",children:[(0,i.jsx)("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:"Headless Training Mode Active"}),(0,i.jsxs)("div",{className:"text-sm text-gray-600 mb-4",children:["Running ",L," games simultaneously (no rendering for better performance)"]}),(0,i.jsxs)("div",{className:"text-sm text-gray-600",children:["Auto-save: ",n>0?`${n} model(s) saved`:"Waiting for first save..."]})]})]})}let e8={width:(a=g(r.default,function(e){return!!o(e)&&u(e,"width",l)&&u(e,"height",l)&&u(e,"barriers",e=>d(e))&&u(e,"spawnPoints",e=>d(e))&&(!("suns"in e)||u(e,"suns",e=>d(e)))},"Invalid map data structure: missing or invalid required properties")).width,height:a.height,barriers:a.barriers,spawnPoints:a.spawnPoints,suns:a.suns||[]};function e7({onBack:e}){let t=e8.barriers||[],a=[],[r,n]=(0,s.useState)(!1),[o,l]=(0,s.useState)(!1),[d,c]=(0,s.useState)(null),[h,u]=(0,s.useState)(null),[g,m]=(0,s.useState)(()=>ek(e8,t,a)),[x,y]=(0,s.useState)([]),[v,w]=(0,s.useState)({blue:0,red:0}),[b,T]=(0,s.useState)(null),[k,S]=(0,s.useState)(!1),[N,M]=(0,s.useState)([]),[j,E]=(0,s.useState)(null),[A,P]=(0,s.useState)(null),[D,R]=(0,s.useState)(!1),[I,L]=(0,s.useState)(null),C=f(),B=p({gameOver:null!==b}),F=(0,s.useCallback)(async()=>{n(!0),c(null),l(!1);try{let e=h;if(!e){let t=new e0(eZ);await t.initialize(),u(t),e=t;let a=new eL({name:"TankTroubleRL",type:"discrete",observationSize:eZ.observationSize,actionSize:eZ.actionSize}),i={isLoaded:()=>!0,load:async t=>{e&&await e.load(t)},getInfo:()=>a.getInfo(),agent:e,predict:async(t,a)=>{if(!e)return console.warn("Agent not initialized, returning default decision"),{angleDelta:0,moveDirection:0,shouldShoot:!1};try{return await e.predict(t,a)}catch(e){return console.error("Error in agent predict:",e),{angleDelta:0,moveDirection:0,shouldShoot:!1}}}};eC.setModel(i)}if(!e)throw Error("Failed to initialize DQN agent");let t=await fetch("/api/backend/models/latest");if(!t.ok){let e=await t.json().catch(()=>({error:"Unknown error"}));throw Error(e.error||`Failed to fetch model: ${t.statusText}`)}let a=await t.json();console.log("Model data received from Supabase:",{layersCount:a.layers?.length||0,hasMetadata:!!a.metadata,metadata:a.metadata});let i=a.layers.map((e,t)=>{let a=e.weights||e.Weights||[],i=e.biases||e.Biases||[],s=a.filter(e=>Math.abs(e)>1e-10).length,r=i.filter(e=>Math.abs(e)>1e-10).length,n=a.length,o=i.length,l=a.slice(0,10),d=i.slice(0,5);return console.log(`Layer ${t}:`,{weightsCount:n,biasesCount:o,nonZeroWeights:s,nonZeroBiases:r,weightSample:l,biasSample:d,allZeros:0===s&&0===r}),{weights:a,biases:i}});await e.loadWeightsFromJSON(i);let s={vector:Array(eZ.observationSize).fill(.5),size:eZ.observationSize};try{let t=await e.selectAction(s,!1);console.log("Model verification - test action:",t,"(should be 0-",eZ.actionSize-1,")");let a=await e.predict(s,0);console.log("Model verification - test decision:",a)}catch(e){console.error("Model verification failed:",e)}l(!0),console.log("Successfully loaded latest model from Supabase",a.metadata)}catch(e){console.error("Failed to load model from Supabase:",e),c(e instanceof Error?e.message:String(e)),l(!1)}finally{n(!1)}},[h]);(0,s.useEffect)(()=>{F()},[F]);let z=(0,s.useCallback)(async()=>{if(0!==N.length){R(!0),L(null);try{let e=await fetch("http://localhost:8080/api/demonstrations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({steps:N,isDefault:!0,metadata:{episodeLength:N.length,totalReward:0,timestamp:new Date().toISOString()}})});if(!e.ok){let t=await e.text();throw Error(`Failed to save: ${e.status} ${t}`)}let t=await e.json();L(`✅ Saved ${t.steps} demonstration steps`),M([]),E(null),P(null)}catch(t){let e=t instanceof Error?t.message:String(t);L(`❌ Failed to save: ${e}`),console.error("Failed to save demonstrations:",t)}finally{R(!1)}}},[N]),$=(0,s.useCallback)(()=>{null!==b&&N.length>0&&z(),m(ek(e8,t,a)),y([]),w({blue:0,red:0}),T(null),S(!1),E(null),P(null)},[e8,t,a,b,N,z]),q=eG({mapData:e8,barriers:t,suns:a,aiConfig:eF,trainingManager:null,maxEpisodeTimeMs:Number.MAX_SAFE_INTEGER,gameInstances:[(0,s.useMemo)(()=>({id:0,tanks:g,bullets:x,lastShotTimes:v,gameMode:"person-vs-ai",gameId:"play-ai-game",isPaused:k,speedMultiplier:1,episodeStartTime:Date.now(),keysRef:B.keysRef}),[g,x,v,k,B.keysRef])],onTanksUpdate:(e,t)=>{m(t),(t[0]?.lives<=0||t[1]?.lives<=0)&&T(t[0]?.lives<=0?"red":"blue")},onBulletsUpdate:(e,t)=>{y(t)},onLastShotTimesUpdate:(e,t)=>{w(t)},onGameOver:(e,t)=>{T(t)}});return(0,s.useEffect)(()=>{if(k||!o||null!==b||g.length<2)return;let e=g[0],i=g[1];if(!e||!i)return;let s=eP({aiTank:e,enemyTank:i,bullets:x,barriers:t,suns:a,mapWidth:e8.width,mapHeight:e8.height,tickTime:Date.now(),config:eF});if(j&&null!==A){let t=e.lives<=0||i.lives<=0,a={state:j.vector,action:A,reward:.1,nextState:s.vector,done:t};M(e=>[...e,a])}let r=function(e,t={rotateLeft:"arrowleft",rotateRight:"arrowright",moveForward:"arrowup",moveBackward:"arrowdown",shoot:" "}){let a=e.has(t.rotateLeft),i=e.has(t.rotateRight),s=e.has(t.moveForward),r=e.has(t.moveBackward);if(e.has(t.shoot)){if(s)return 10;if(r)return 11;if(a)return 8;else if(i)return 9;return 5}return s?a?6:i?7:3:r?a?12:i?13:4:a?1:2*!!i}(B.keysRef.current);E(s),P(r)},[g,x,t,a,B.keysRef,k,o,b,j,A,e8]),(0,s.useEffect)(()=>{null!==b&&N.length>0&&!D&&z()},[b,N.length,D,z]),(0,s.useEffect)(()=>{if(k||!o||null!==b)return;let e=Date.now(),t=async()=>{let a=Date.now();a-e>=Y&&(await q.gameTick({skipIntervalCheck:!1}),e=a),requestAnimationFrame(t)},a=requestAnimationFrame(t);return()=>cancelAnimationFrame(a)},[k,o,b,q]),(0,s.useEffect)(()=>{let e=e=>{"Escape"===e.key&&S(e=>!e)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.jsxs)("div",{className:"flex flex-col items-center gap-4 w-full p-4",children:[(0,i.jsxs)("div",{className:"w-full max-w-4xl flex items-center justify-between",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold",children:"Play Your AI"}),(0,i.jsx)("button",{onClick:e,className:"px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300",children:"Back to Training"})]}),(0,i.jsxs)("div",{className:"w-full max-w-4xl p-4 bg-white border border-gray-300 rounded shadow",children:[(0,i.jsxs)("div",{className:"flex items-center gap-4",children:[(0,i.jsx)("label",{className:"text-sm font-semibold",children:"AI Model:"}),r?(0,i.jsx)("span",{className:"text-sm text-gray-600",children:"Loading latest model from Supabase..."}):o?(0,i.jsx)("span",{className:"text-sm text-green-600",children:"✓ Latest model loaded from Supabase"}):d?(0,i.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,i.jsx)("span",{className:"text-sm text-red-600",children:"✗ Failed to load model"}),(0,i.jsx)("span",{className:"text-xs text-gray-500",children:d}),(0,i.jsx)("button",{onClick:F,className:"mt-2 px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600",children:"Retry"})]}):(0,i.jsx)("span",{className:"text-sm text-gray-600",children:"Ready to load"})]}),(0,i.jsx)("div",{className:"mt-3 pt-3 border-t border-gray-200",children:(0,i.jsxs)("div",{className:"flex items-center gap-4",children:[(0,i.jsx)("label",{className:"text-sm font-semibold",children:"Demonstration Collection:"}),N.length>0?(0,i.jsxs)("span",{className:"text-sm text-blue-600",children:["📝 ",N.length," steps collected"]}):(0,i.jsx)("span",{className:"text-sm text-gray-500",children:"Not collecting"}),D&&(0,i.jsx)("span",{className:"text-sm text-gray-600",children:"Saving..."}),I&&(0,i.jsx)("span",{className:`text-sm ${I.startsWith("✅")?"text-green-600":"text-red-600"}`,children:I})]})})]}),(0,i.jsx)("div",{className:"w-full max-w-4xl p-4 bg-white border border-gray-300 rounded shadow",children:(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{className:"flex gap-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-sm text-gray-600",children:"You (Blue): "}),(0,i.jsxs)("span",{className:"font-semibold text-blue-600",children:[g[0]?.lives??0," lives"]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-sm text-gray-600",children:"AI (Red): "}),(0,i.jsxs)("span",{className:"font-semibold text-red-600",children:[g[1]?.lives??0," lives"]})]})]}),k&&(0,i.jsx)("div",{className:"text-lg font-semibold text-gray-600",children:"PAUSED (Press ESC to resume)"}),b&&(0,i.jsx)("div",{className:"text-lg font-semibold",children:"blue"===b?(0,i.jsx)("span",{className:"text-blue-600",children:"You Win!"}):(0,i.jsx)("span",{className:"text-red-600",children:"AI Wins!"})})]})}),o?(0,i.jsx)("div",{className:"flex justify-center",children:(0,i.jsx)(eU,{width:e8.width,height:e8.height,tanks:g,bullets:x,barriers:t,suns:a,isPaused:k,tankImages:C,gameOverWinner:b,scale:1})}):(0,i.jsx)("div",{className:"w-full max-w-4xl p-8 bg-gray-100 border border-gray-300 rounded text-center",children:(0,i.jsx)("div",{className:"text-lg text-gray-600",children:r?"Loading model from Supabase...":"Waiting for AI model to load from Supabase"})}),(0,i.jsx)("div",{className:"w-full max-w-4xl p-4 bg-white border border-gray-300 rounded shadow",children:(0,i.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,i.jsx)("div",{className:"font-semibold mb-2",children:"Controls:"}),(0,i.jsx)("div",{children:"Player 1 (Blue - You): Arrow keys to move, Space to shoot"}),(0,i.jsx)("div",{children:"Press ESC to pause/resume"}),b&&(0,i.jsx)("button",{onClick:$,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Play Again"})]})})]})}function e9({view:e,onViewChange:t}){return"play"===e?(0,i.jsx)(e7,{onBack:()=>t("training")}):(0,i.jsx)(e4,{})}e.s(["default",()=>e9],7821)}]);